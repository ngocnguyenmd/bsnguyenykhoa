<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xem Anime</title>

  <!-- Preload HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.13"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:'Segoe UI',sans-serif;background:#0a0a0a;color:#eee}
    a{text-decoration:none}
    #player-area{width:1100px;max-width:1500px;margin:20px auto;height:60vh;position:relative;overflow:hidden;background:#000;border-radius:12px;box-shadow:0 0 30px rgba(229,9,20,0.4);}
    #player-area video,#player-area iframe{width:100%;height:100%;border:none;background:#000;}
    .title-bar{max-width:800px;margin:10px auto 20px;padding:12px;text-align:center;font-weight:700;color:#ff0000;background:#1a1a1a;border:1px solid #ff0000;border-radius:8px;}
    .ep-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px;padding:12px;max-width:900px;margin:auto;}
    .ep-btn{width:40px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font:500 14px/1 sans-serif;border:1px solid #161515;border-radius:6px;cursor:pointer;transition:background .15s,opacity .15s,transform .15s;}
    .ep-btn:hover,.ep-btn.active{background:#ff0000;opacity:.9;transform:scale(1.05)}
    .ctl-bar,.server-select,.mode-switch{display:flex;gap:10px;justify-content:center;max-width:900px;margin:10px auto;padding:0 12px;flex-wrap:wrap;}
    .ctl-btn,.server-btn,.mode-btn{padding:8px 16px;background:#ff0000;color:#fff;border:none;border-radius:6px;font:600 14px/1 sans-serif;cursor:pointer;transition:opacity .15s;}
    .ctl-btn:hover,.server-btn:hover,.mode-btn:hover{opacity:.85}
    .server-btn,.mode-btn{background:#1a1a1a;border:1px solid #ff0000}
    .server-btn.active,.mode-btn.active{background:#ff0000}
    .back-btn{display:block;max-width:900px;margin:20px auto 40px;padding:12px;background:#ff0000;color:#fff;text-align:center;border-radius:8px;font:600 16px/1 sans-serif;transition:opacity .15s;}
    .back-btn:hover{opacity:.85}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:12px 20px;border-radius:6px;font:500 15px/1 sans-serif;visibility:hidden;opacity:0;transition:opacity .2s;z-index:9999;min-width:200px;text-align:center;}
    #toast.show{visibility:visible;opacity:1}

    /* Popup */
    #popup-confirm{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000;visibility:hidden;opacity:0;transition:opacity .2s;}
    #popup-box{background:#1a1a1a;padding:24px;border-radius:12px;max-width:400px;text-align:center;color:#fff;border:2px solid #ff0000;}
    #popup-box p{margin-bottom:20px;font-size:16px;}
    .popup-btn{padding:8px 20px;margin:0 10px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:opacity .15s;}
    .popup-btn:hover{opacity:.85;}
    .popup-yes{background:#ff0000;color:#fff;}
    .popup-no{background:#555;color:#fff;}

    /* Loading */
    .loading-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10;}
    .spinner{width:50px;height:50px;border:5px solid #333;border-top:5px solid #ff0000;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:480px){
      #player-area{height:56vh}
      .ep-grid{gap:6px}
      #toast{bottom:70px;width:90%}
      .ctl-bar,.server-select,.mode-switch{gap:8px;}
      .ctl-btn,.server-btn,.mode-btn{padding:8px 12px;font-size:13px;}
    }
  </style>
</head>
<body>

<div class="title-bar" id="title-bar">Tên Phim: Đang tải... | Tập: 1</div>
<div id="player-area">
  <div class="loading-overlay"><div class="spinner"></div></div>
</div>

<div class="server-select" id="server-select"></div>
<div class="mode-switch" id="mode-switch"></div>

<div class="ctl-bar">
  <button class="ctl-btn" onclick="prevEp()">Tập trước</button>
  <button class="ctl-btn" onclick="seekBackward()">-30s</button>
  <button class="ctl-btn" onclick="seekForward()">+30s</button>
  <button class="ctl-btn" onclick="nextEp()">Tập sau</button>
</div>

<div class="ep-grid" id="ep-grid"></div>
<a href="index1.html" class="back-btn">Quay lại Trang Chủ</a>
<div id="toast">Thông báo</div>

<!-- Popup -->
<div id="popup-confirm">
  <div id="popup-box">
    <p>Bạn có muốn chuyển sang tập kế tiếp ngay bây giờ không?</p>
    <button class="popup-btn popup-yes" id="popup-yes">Có</button>
    <button class="popup-btn popup-no" id="popup-no">Không</button>
  </div>
</div>


<script>
let slug = new URLSearchParams(location.search).get('slug');
let source = new URLSearchParams(location.search).get('source');

const playerArea = document.getElementById('player-area');
const grid = document.getElementById('ep-grid');
const serverSelect = document.getElementById('server-select');
const modeSwitch = document.getElementById('mode-switch');
const titleBar = document.getElementById('title-bar');
const popup = document.getElementById('popup-confirm');
const popupYes = document.getElementById('popup-yes');
const popupNo = document.getElementById('popup-no');
const toastEl = document.getElementById('toast');

let servers = [], episodes = [], currentServer = 0, current = 0;
let movieName = '', hls = null;
let currentMode = 'm3u8';
let warned = false;

// ---------------- Đọc tập từ URL ----------------
function getEpisodeFromURL() {
  const params = new URLSearchParams(location.search);
  for (let i = 1; i <= 500; i++) {
    if (params.has(`e${i}`)) return i - 1;
  }
  return 0;
}

// ---------------- Cập nhật URL (không reload) ----------------
function updateURL(epIndex, newSource = source) {
  current = epIndex;
  const epParam = `e${epIndex + 1}`;
  const newUrl = `${location.pathname}?slug=${slug}&source=${newSource}&${epParam}`;
  history.replaceState({ ep: epIndex, source: newSource }, '', newUrl);
}

// ---------------- Đổi nguồn (KHÔNG RELOAD) ----------------
async function changeSource(newSource) {
  if (newSource === source) return;
  if (!slug) return showToast('Thiếu slug!');

  // Cập nhật URL ngay (không reload)
  updateURL(current, newSource);

  // Cập nhật biến toàn cục
  source = newSource;

  // Tải lại dữ liệu phim
  await loadMovieData();

  // Phát lại tập hiện tại
  if (episodes.length > current) {
    playEp(current);
  } else if (episodes.length > 0) {
    playEp(0);
  }
}

// ---------------- Tải dữ liệu phim ----------------
async function loadMovieData() {
  let api = '';
  if (source === 'Nguonc') api = `https://phim.nguonc.com/api/film/${slug}`;
  else if (source === 'Phimapi') api = `https://phimapi.com/phim/${slug}`;
  else if (source === 'Ophim') api = `https://ophim1.com/v1/api/phim/${slug}`;
  else return showToast('Nguồn không hỗ trợ!');

  try {
    const res = await fetch(api);
    if (!res.ok) throw new Error('API lỗi');
    const data = await res.json();

    movieName = source === 'Nguonc' ? data.movie?.name :
                source === 'Phimapi' ? data.movie?.name :
                data.data?.item?.name || 'Không rõ';

    servers = [];

    if (source === 'Nguonc' && Array.isArray(data.movie?.episodes)) {
      data.movie.episodes.forEach((g, i) => {
        const items = Array.isArray(g.items) ? g.items : [];
        if (items.length) servers.push({ server_name: g.server_name || `Server ${i + 1}`, server_data: items });
      });
    } else if (source === 'Phimapi' && Array.isArray(data.episodes)) {
      data.episodes.forEach((s, i) => {
        const d = Array.isArray(s.server_data) ? s.server_data : [];
        if (d.length) servers.push({ server_name: s.server_name || `Server ${i + 1}`, server_data: d });
      });
    } else if (source === 'Ophim' && Array.isArray(data.data?.item?.episodes)) {
      data.data.item.episodes.forEach((g, i) => {
        const d = Array.isArray(g.server_data) ? g.server_data : [];
        if (d.length) servers.push({ server_name: g.server_name || `Server ${i + 1}`, server_data: d });
      });
    }

    if (!servers.length) {
      playerArea.innerHTML = '<p style="color:#f66;text-align:center;">Không có tập phim nào</p>';
      showToast('Không tìm thấy tập phim!');
      return false;
    }

    renderServerSelect();
    switchServer(0);
    renderModeSwitch();
    return true;
  } catch (e) {
    console.error(e);
    playerArea.innerHTML = '<p style="color:#f66;text-align:center;">Lỗi tải dữ liệu</p>';
    showToast('Không thể kết nối API!');
    return false;
  }
}

// ---------------- Thêm nút chọn nguồn ----------------
function addSourceSwitcher() {
  const ctlBar = document.querySelector('.ctl-bar');
  if (!ctlBar.querySelector('.source-switcher')) {
    const btn = document.createElement('button');
    btn.className = 'ctl-btn source-switcher';
    btn.textContent = 'Nguồn';
    btn.style.background = '#ff6600';
    btn.onclick = showSourcePopup;
    const nextBtn = ctlBar.querySelector('button[onclick="nextEp()"]');
    ctlBar.insertBefore(btn, nextBtn);
  }
}

// ---------------- Popup chọn nguồn ----------------
function showSourcePopup() {
  const existing = document.getElementById('source-popup');
  if (existing) existing.remove();

  const sources = ['Ophim', 'Phimapi', 'Nguonc'].map(v => ({ name: v, value: v }));

  const popup = document.createElement('div');
  popup.id = 'source-popup';
  popup.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10001;';

  const box = document.createElement('div');
  box.style.cssText = 'background:#1a1a1a;padding:24px;border-radius:12px;max-width:320px;width:90%;text-align:center;color:#fff;border:2px solid #ff6600;';

  const title = document.createElement('p');
  title.textContent = 'Chọn nguồn phát';
  title.style.cssText = 'margin-bottom:16px;font-weight:700;font-size:18px;';
  box.appendChild(title);

  sources.forEach(src => {
    const btn = document.createElement('button');
    btn.textContent = src.name;
    btn.style.cssText = `
      display:block;width:100%;margin:8px 0;padding:12px;
      background:${source === src.value ? '#ff6600' : '#333'};
      color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;
    `;
    btn.onmouseover = () => btn.style.opacity = '0.9';
    btn.onmouseout = () => btn.style.opacity = '1';
    btn.onclick = () => changeSource(src.value).then(() => popup.remove());
    box.appendChild(btn);
  });

  const close = document.createElement('button');
  close.textContent = 'Đóng';
  close.style.cssText = 'margin-top:16px;padding:10px 20px;background:#555;color:#fff;border:none;border-radius:6px;cursor:pointer;';
  close.onclick = () => popup.remove();
  box.appendChild(close);

  popup.appendChild(box);
  document.body.appendChild(popup);
  popup.onclick = e => e.target === popup && popup.remove();
}

// ---------------- Play Episode ----------------
function playEp(i) {
  if (i < 0 || i >= episodes.length) return;
  current = i;
  mark(i);
  updateURL(i); // Cập nhật URL

  const ep = episodes[i] || {};
  const embed = ep.embed || ep.link_embed || '';
  const m3u8 = ep.m3u8 || ep.link_m3u8 || '';

  titleBar.textContent = `Tên Phim: ${movieName} | Tập: ${i + 1}`;
  warned = false;

  if (currentMode === 'embed' && embed) renderEmbed(embed);
  else if (currentMode === 'm3u8' && m3u8) renderHLS(m3u8, embed);
  else if (m3u8) renderHLS(m3u8, embed);
  else if (embed) renderEmbed(embed);
  else {
    playerArea.innerHTML = '<p style="color:#f66;text-align:center;">Không có link phát!</p>';
    showToast('Không có nguồn!');
  }
}

// ---------------- Render Embed ----------------
function renderEmbed(url) {
  playerArea.innerHTML = `<iframe src="${url}" frameborder="0" allowfullscreen allow="autoplay; encrypted-media" style="width:100%;height:100%"></iframe>`;
}

// ---------------- Render HLS ----------------
function renderHLS(m3u8Url, fallbackEmbed) {
  playerArea.innerHTML = `
    <video id="hls-video" controls playsinline style="width:100%;height:100%;background:#000;"></video>
    <div class="loading-overlay"><div class="spinner"></div></div>
  `;

  const video = document.getElementById('hls-video');
  const loading = playerArea.querySelector('.loading-overlay');
  video.muted = true;
  let hasPlayed = false;

  const startPlay = () => {
    if (hasPlayed) return;
    video.play().catch(() => showToast('Nhấn Play để xem'));
    hasPlayed = true;
  };

  if (Hls.isSupported()) {
    if (hls) hls.destroy();
    hls = new Hls({ enableWorker: true, lowLatencyMode: true });
    hls.loadSource(m3u8Url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      loading.style.display = 'none';
      startPlay();
    });
    hls.on(Hls.Events.ERROR, (e, d) => {
      if (d.fatal) {
        loading.style.display = 'none';
        if (fallbackEmbed && currentMode !== 'embed') {
          showToast('M3U8 lỗi → chuyển Embed');
          setTimeout(() => renderEmbed(fallbackEmbed), 500);
        } else showToast('Lỗi phát video!');
      }
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = m3u8Url;
    video.addEventListener('loadedmetadata', () => {
      loading.style.display = 'none';
      startPlay();
    });
  } else {
    loading.style.display = 'none';
    if (fallbackEmbed) {
      showToast('Không hỗ trợ HLS → dùng Embed');
      renderEmbed(fallbackEmbed);
    } else showToast('Trình duyệt không hỗ trợ!');
  }

  video.addEventListener('ended', nextEp);
  video.addEventListener('timeupdate', () => {
    if (!warned && video.duration && video.currentTime >= video.duration - 120) {
      warned = true;
      popup.style.visibility = 'visible';
      popup.style.opacity = '1';
    }
  });
}

// ---------------- Mode Switch ----------------
function switchMode(mode) {
  currentMode = mode;
  [...modeSwitch.children].forEach((b, i) => b.classList.toggle('active', (i === 0 && mode === 'm3u8') || (i === 1 && mode === 'embed')));
  if (current >= 0) playEp(current);
}

function renderModeSwitch() {
  modeSwitch.innerHTML = '';
  const hasEmbed = episodes.some(ep => ep.embed || ep.link_embed);
  const hasM3u8 = episodes.some(ep => ep.m3u8 || ep.link_m3u8);
  if (hasEmbed && hasM3u8) {
    modeSwitch.append(
      Object.assign(document.createElement('button'), { className: 'mode-btn', textContent: 'M3U8', onclick: () => switchMode('m3u8') }),
      Object.assign(document.createElement('button'), { className: 'mode-btn', textContent: 'Embed', onclick: () => switchMode('embed') })
    );
    switchMode(currentMode);
  }
}

// ---------------- Server Switch ----------------
function switchServer(i) {
  if (i < 0 || i >= servers.length) return;
  currentServer = i;
  episodes = servers[i].server_data || [];
  [...serverSelect.children].forEach((b, k) => b.classList.toggle('active', k === i));
  renderGrid();
  renderModeSwitch();
  playEp(Math.min(current, episodes.length - 1));
}

// ---------------- Render Server Select ----------------
function renderServerSelect() {
  serverSelect.innerHTML = '';
  if (!servers.length) return;

  servers.forEach((s, i) => {
    const count = Array.isArray(s.server_data) ? s.server_data.length : 0;
    if (count === 0) return;
    const name = s.server_name || `Server ${i + 1}`;
    const btn = Object.assign(document.createElement('button'), {
      className: 'server-btn',
      textContent: `${name} (${count})`,
      onclick: () => switchServer(i)
    });
    if (i === currentServer) btn.classList.add('active');
    serverSelect.appendChild(btn);
  });
}

// ---------------- Grid ----------------
function renderGrid() {
  grid.innerHTML = '';
  episodes.forEach((_, i) => {
    const b = Object.assign(document.createElement('div'), {
      className: 'ep-btn',
      textContent: i + 1,
      onclick: () => playEp(i)
    });
    if (i === current) b.classList.add('active');
    grid.appendChild(b);
  });
}

function mark(i) {
  [...grid.children].forEach((b, k) => b.classList.toggle('active', k === i));
}

// ---------------- Navigation ----------------
function prevEp() { if (current > 0) playEp(current - 1); else showToast('Đang ở tập đầu!'); }
function nextEp() { if (current < episodes.length - 1) playEp(current + 1); else showToast('Hết tập!'); }

function seekForward() {
  const v = document.getElementById('hls-video');
  if (v) v.currentTime = Math.min(v.currentTime + 30, v.duration || Infinity);
}
function seekBackward() {
  const v = document.getElementById('hls-video');
  if (v) v.currentTime = Math.max(v.currentTime - 30, 0);
}

// ---------------- Popup ----------------
popupYes.onclick = () => { popup.style.opacity = '0'; setTimeout(() => popup.style.visibility = 'hidden', 200); nextEp(); };
popupNo.onclick = () => { popup.style.opacity = '0'; setTimeout(() => popup.style.visibility = 'hidden', 200); };

// ---------------- Toast ----------------
function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl.timeout);
  toastEl.timeout = setTimeout(() => toastEl.classList.remove('show'), 3000);
}

// ---------------- Main ----------------
async function main() {
  const params = new URLSearchParams(location.search);
  slug = params.get('slug');
  source = params.get('source');

  if (!slug || !source) {
    playerArea.innerHTML = '<p style="color:#f66;text-align:center;">Thiếu slug/source</p>';
    showToast('Thiếu thông tin!');
    return;
  }

  addSourceSwitcher();

  // Lấy tập từ URL
  current = getEpisodeFromURL();

  // Tải dữ liệu
  const success = await loadMovieData();
  if (!success) return;

  // Phát tập hiện tại
  if (current < episodes.length) {
    playEp(current);
  } else if (episodes.length > 0) {
    current = 0;
    playEp(0);
  }

  window.addEventListener('popstate', e => {
    if (e.state?.ep !== undefined) {
      current = e.state.ep;
      source = e.state.source || source;
      loadMovieData().then(() => playEp(current));
    }
  });
}

// ---------------- Run ----------------
main();
</script>
</body>
</html>