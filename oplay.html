<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Phát Phim</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.13"></script>
<style>
:root {
  --primary: #0a84ff;
  --primary-dark: #006edc;
  --dark: #0f0f0f;
  --darker: #0a0a0a;
  --gray: #1f1f1f;
  --light-gray: #2a2a2a;
  --radius: 16px;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--darker);
  color: #fff;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 1.6;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}

/* HEADER */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: rgba(15, 15, 15, 0.98);
  padding: 16px 0;
  z-index: 1000;
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
}

.nav-btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: #fff;
  font-size: 1.4rem;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.nav-btn:hover {
  background: var(--primary);
  transform: scale(1.05);
}

.logo {
  font-size: 1.8rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), #ff2d92);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  cursor: pointer;
  text-align: center;
  flex: 1;
}

/* MAIN PLAYER */
.main-content {
  margin-top: 90px;
  margin-bottom: 40px;
}

.player-wrapper {
  background: var(--dark);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.player-header {
  padding: 24px 32px;
  background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), transparent);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.player-title {
  font-size: 1.8rem;
  font-weight: 800;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff, var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1.3;
}

.current-ep {
  font-size: 1.1rem;
  color: #aaa;
  font-weight: 500;
}

/* VIDEO PLAYER */
.player-iframe-box {
  position: relative;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  background: #000;
  overflow: hidden;
}

#player-area {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

#hls-video, #embed-frame {
  width: 100%;
  height: 100%;
  border: none;
  background: #000;
  display: none;
}

.loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #222;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-msg {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  color: #ff6b6b;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  text-align: center;
  padding: 20px;
  display: none;
  z-index: 20;
}

/* CONTROLS */
.controls-section {
  padding: 20px;
  background: var(--dark);
  border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.control-group {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  margin-bottom: 16px;
}

.control-group:last-child {
  margin-bottom: 0;
}

.control-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 120px;
  justify-content: center;
}

.control-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

.control-btn.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
}

.control-btn i {
  font-size: 0.9rem;
}

/* SOURCE SELECTION */
.source-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.source-btn {
  padding: 10px 20px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  background: transparent;
  color: #fff;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 100px;
}

.source-btn:hover {
  border-color: var(--primary);
  background: rgba(10, 132, 255, 0.1);
}

.source-btn.active {
  border-color: var(--primary);
  background: var(--primary);
  color: #fff;
}

/* EPISODES */
.episode-section {
  margin: 40px 0;
}

.episode-header {
  margin-bottom: 20px;
  text-align: center;
}

.episode-title {
  font-size: 1.6rem;
  font-weight: 700;
  background: linear-gradient(135deg, #fff, var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}

.episode-subtitle {
  color: #aaa;
  font-size: 1rem;
}

.episode-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  background: var(--dark);
  border-radius: var(--radius);
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.ep-btn {
  padding: 12px 8px;
  text-align: center;
  background: var(--light-gray);
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
  font-size: 0.9rem;
}

.ep-btn:hover {
  background: var(--primary);
  transform: translateY(-2px);
}

.ep-btn.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
}

/* FOOTER */
.footer {
  text-align: center;
  padding: 30px 0;
}

.home-btn-large {
  padding: 14px 32px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
  font-size: 1rem;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.home-btn-large:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(10, 132, 255, 0.4);
}

/* TOAST & POPUP */
#toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--dark);
  color: #fff;
  padding: 14px 24px;
  border: 1px solid var(--primary);
  border-radius: 12px;
  font-size: 0.95rem;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 9999;
  box-shadow: var(--shadow);
}

#toast.show {
  visibility: visible;
  opacity: 1;
}

#popup-confirm {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s;
}

#popup-confirm.show {
  visibility: visible;
  opacity: 1;
}

#popup-box {
  background: var(--dark);
  padding: 24px;
  border: 1px solid var(--primary);
  border-radius: var(--radius);
  color: #fff;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: var(--shadow);
}

.popup-btn {
  padding: 10px 20px;
  margin: 8px;
  min-width: 80px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.popup-yes {
  background: var(--primary);
  color: #fff;
}

.popup-yes:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.popup-no {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
}

.popup-no:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .container {
    padding: 0 16px;
  }
  
  .main-content {
    margin-top: 80px;
  }
  
  .player-header {
    padding: 20px;
  }
  
  .player-title {
    font-size: 1.4rem;
  }
  
  .current-ep {
    font-size: 1rem;
  }
  
  .control-group {
    flex-direction: column;
    align-items: center;
  }
  
  .control-btn {
    width: 100%;
    max-width: 280px;
  }
  
  .source-selector {
    justify-content: center;
  }
  
  .source-btn {
    min-width: 80px;
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .episode-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  }
  
  .ep-btn {
    padding: 10px 6px;
    font-size: 0.85rem;
  }
}

@media (max-width: 480px) {
  .nav {
    gap: 12px;
  }
  
  .logo {
    font-size: 1.4rem;
  }
  
  .nav-btn {
    width: 42px;
    height: 42px;
    font-size: 1.2rem;
  }
  
  .player-title {
    font-size: 1.2rem;
  }
  
  .episode-title {
    font-size: 1.3rem;
  }
  
  .episode-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <button class="nav-btn" onclick="history.back()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="logo" onclick="location.href='index.html'">Bánh Mì</div>
    <button class="nav-btn" onclick="location.href='index.html'">
      <i class="fas fa-home"></i>
    </button>
  </div>
</header>

<div class="container main-content">
  <div class="player-wrapper">
    <div class="player-header">
      <h1 class="player-title" id="title">Đang tải...</h1>
      <div class="current-ep" id="currentEp">Đang tải...</div>
    </div>
    
    <div class="player-iframe-box">
      <div id="player-area">
        <div class="loading-overlay">
          <div class="spinner"></div>
        </div>
        <video id="hls-video" playsinline controls preload="auto"></video>
        <iframe id="embed-frame" allowfullscreen allow="autoplay"></iframe>
        <div class="error-msg" id="error-msg">Lỗi phát nguồn này</div>
      </div>
    </div>
    
    <!-- SOURCE SELECTION - HIỂN THỊ RÕ RÀNG -->
    <div class="controls-section">
      <div class="control-group">
        <div class="source-selector" id="source-selector">
          <button class="source-btn active" data-src="ax">AX - Ophim</button>
          <button class="source-btn" data-src="bx">BX - Phimapi</button>
          <button class="source-btn" data-src="cx">CX - Nguonc</button>
          <button class="source-btn" data-src="vidlink">Vidlink</button>
          <button class="source-btn" data-src="videasy">Videasy</button>
          <button class="source-btn" data-src="vidsrc">Vidsrc</button>
        </div>
      </div>
      
      <!-- PLAYBACK MODE -->
      <div class="control-group" id="mode-controls">
        <button class="control-btn active" data-mode="m3u8">
          <i class="fas fa-play-circle"></i>M3U8
        </button>
        <button class="control-btn" data-mode="embed">
          <i class="fas fa-external-link-alt"></i>Embed
        </button>
      </div>
      
      <!-- SERVER SELECTION -->
      <div class="control-group" id="server-controls"></div>
      
      <!-- PLAYBACK CONTROLS -->
      <div class="control-group">
        <button class="control-btn" onclick="prevEp()">
          <i class="fas fa-step-backward"></i>Tập trước
        </button>
        <button class="control-btn" onclick="seek(-30)">
          <i class="fas fa-backward"></i>-30s
        </button>
        <button class="control-btn" onclick="seek(30)">
          <i class="fas fa-forward"></i>+30s
        </button>
        <button class="control-btn" onclick="nextEp()">
          <i class="fas fa-step-forward"></i>Tập sau
        </button>
      </div>
    </div>
  </div>

  <!-- EPISODES SECTION -->
  <div class="episode-section" id="episodeSection" style="display:none;">
    <div class="episode-header">
      <h2 class="episode-title">Danh sách tập phim</h2>
      <div class="episode-subtitle" id="episodeSubtitle">Chọn tập để xem</div>
    </div>
    <div class="episode-grid" id="epGrid"></div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <button class="home-btn-large" onclick="location.href='index.html'">
      <i class="fas fa-home"></i>Quay về trang chủ
    </button>
  </div>
</div>

<!-- TOAST & POPUP -->
<div id="toast">Thông báo</div>
<div id="popup-confirm">
  <div id="popup-box">
    <p style="margin-bottom: 20px; font-size: 1.1rem;">Bạn có muốn chuyển sang tập tiếp theo không?</p>
    <div>
      <button class="popup-btn popup-yes">Có, chuyển tập</button>
      <button class="popup-btn popup-no">Ở lại tập này</button>
    </div>
  </div>
</div>

<script>
// ==================== CẤU HÌNH & BIẾN TOÀN CỤC ====================
const params = new URLSearchParams(location.search);
const slug = params.get('slug');
let tmdb = params.get('tmdb');
let type = params.get('type') || 'movie';
let season = Math.max(1, parseInt(params.get('s')) || 1);
let episode = Math.max(1, parseInt(params.get('e')) || 1);
let mainSource = params.get('source') || 'bx';

const TMDB_API_KEY = 'c1ba4826351c415243b3d8ea82a77cd7';
const BASE_TMDB = 'https://api.themoviedb.org/3';

// DOM Elements
const playerArea = document.getElementById('player-area');
const videoEl = document.getElementById('hls-video');
const embedFrame = document.getElementById('embed-frame');
const loading = playerArea.querySelector('.loading-overlay');
const errorMsg = document.getElementById('error-msg');
const titleEl = document.getElementById('title');
const currentEpEl = document.getElementById('currentEp');
const epGrid = document.getElementById('epGrid');
const episodeSection = document.getElementById('episodeSection');
const episodeSubtitle = document.getElementById('episodeSubtitle');
const sourceSelector = document.getElementById('source-selector');
const modeControls = document.getElementById('mode-controls');
const serverControls = document.getElementById('server-controls');
const popup = document.getElementById('popup-confirm');
const popupYes = popup.querySelector('.popup-yes');
const popupNo = popup.querySelector('.popup-no');
const toastEl = document.getElementById('toast');

// State variables
let hls = null;
let servers = [], episodes = [], curSrv = 0, curEp = 0;
let movie = '', poster = '', cdn = '';
let mode = 'm3u8';
let warned = false;
let timeUpdateHandler = null;
let popupTimeout = null;
const movieCache = new Map();

// Source mapping
const srcMap = { ax: 'Ophim', bx: 'Phimapi', cx: 'Nguonc' };
const API = {
  Ophim: slug ? `https://ophim1.com/v1/api/phim/${slug}` : null,
  Phimapi: slug ? `https://phimapi.com/phim/${slug}` : null,
  Nguonc: slug ? `https://phim.nguonc.com/api/film/${slug}` : null
};

// ==================== UTILITY FUNCTIONS ====================
function showToast(message) {
  toastEl.textContent = message;
  toastEl.classList.add('show');
  clearTimeout(toastEl.timeout);
  toastEl.timeout = setTimeout(() => toastEl.classList.remove('show'), 3000);
}

function showEndPopup() {
  if (warned || curEp >= episodes.length - 1) return;
  warned = true;
  popup.classList.add('show');
  clearTimeout(popupTimeout);
  popupTimeout = setTimeout(() => {
    if (warned) {
      popup.classList.remove('show');
      warned = false;
    }
  }, 8000);
}

function epFromUrl() {
  const e = params.get('e');
  return e ? Math.max(0, parseInt(e) - 1) : 0;
}

function updateUrl(ep) {
  curEp = ep;
  const newParams = new URLSearchParams();
  
  if (tmdb) {
    newParams.set('tmdb', tmdb);
    newParams.set('type', type);
    if (type === 'tv') newParams.set('s', season);
    newParams.set('e', ep + 1);
  } else if (slug) {
    newParams.set('slug', slug);
    newParams.set('source', mainSource);
    newParams.set('e', ep + 1);
  }
  
  history.replaceState(null, '', `?${newParams.toString()}`);
}

// ==================== SOURCE & MODE MANAGEMENT ====================
function updateSourceButtons() {
  document.querySelectorAll('.source-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.src === mainSource);
  });
}

function updateModeButtons() {
  document.querySelectorAll('[data-mode]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
}

// ==================== TMDB FUNCTIONS ====================
async function getImdbId() {
  try {
    const url = `${BASE_TMDB}/${type}/${tmdb}?api_key=${TMDB_API_KEY}`;
    const data = await fetch(url).then(r => r.json());
    return data.imdb_id || `tt${tmdb}`;
  } catch {
    return `tt${tmdb}`;
  }
}

function getVidLinkUrl() {
  return type === 'movie' 
    ? `https://vidlink.pro/movie/${tmdb}`
    : `https://vidlink.pro/tv/${tmdb}/${season}/${episode}`;
}

function getVideasyUrl() {
  return type === 'movie'
    ? `https://player.videasy.net/movie/${tmdb}`
    : `https://player.videasy.net/tv/${tmdb}/${season}/${episode}`;
}

async function getVidsrcUrl() {
  const id = await getImdbId();
  return type === 'movie'
    ? `https://vidsrc.icu/embed/movie/${id}`
    : `https://vidsrc.icu/embed/tv/${id}/${season}/${episode}`;
}

// ==================== MOVIE DATA LOADING ====================
async function loadMovie() {
  const srcName = srcMap[mainSource];
  if (!slug || slug === 'null') return false;
  
  if (movieCache.has(srcName)) {
    const cached = movieCache.get(srcName);
    movie = cached.movie;
    poster = cached.poster;
    servers = cached.servers;
    renderServerControls();
    return true;
  }

  try {
    const response = await fetch(API[srcName], { cache: 'force-cache' });
    if (!response.ok) throw new Error('API lỗi');
    const data = await response.json();

    let movieData = {}, epsList = [];
    
    if (srcName === 'Nguonc') {
      movieData = data.movie;
      epsList = movieData.episodes || [];
    } else if (srcName === 'Phimapi') {
      movieData = data.movie;
      epsList = data.episodes || [];
    } else {
      movieData = data.data.item;
      epsList = movieData.episodes || [];
      cdn = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
    }

    movie = movieData.name || movieData.title || 'Không rõ';
    
    // Process servers and episodes
    servers = epsList.map(server => ({
      name: server.server_name || `Server ${servers.length + 1}`,
      data: (server.server_data || server.items || []).map(ep => ({
        name: ep.name || `Tập ${ep.slug?.split('-').pop() || ''}`,
        link_m3u8: srcName === 'Nguonc' ? '' : (ep.link_m3u8 || ep.m3u8 || ''),
        link_embed: ep.link_embed || ep.embed || ''
      })).filter(ep => ep.link_embed || (srcName !== 'Nguonc' && ep.link_m3u8))
    })).filter(server => server.data.length > 0);

    if (servers.length === 0) {
      errorMsg.textContent = 'Không có tập nào';
      errorMsg.style.display = 'flex';
      loading.style.display = 'none';
      return false;
    }

    movieCache.set(srcName, { movie, poster, servers });
    renderServerControls();
    return true;

  } catch (error) {
    console.error('Load movie error:', error);
    errorMsg.textContent = 'Lỗi tải phim';
    errorMsg.style.display = 'flex';
    loading.style.display = 'none';
    return false;
  }
}

async function loadTmdbInfo() {
  try {
    const data = await fetch(`${BASE_TMDB}/${type}/${tmdb}?api_key=${TMDB_API_KEY}&language=vi-VN`).then(r => r.json());
    movie = data.title || data.name || 'Không có tiêu đề';
    poster = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
    
    titleEl.textContent = movie;
    currentEpEl.textContent = type === 'tv' ? `Mùa ${season} - Tập ${episode}` : 'Phim lẻ';

    if (type === 'tv') {
      const seasonData = await fetch(`${BASE_TMDB}/tv/${tmdb}/season/${season}?api_key=${TMDB_API_KEY}&language=vi-VN`).then(r => r.json());
      episodes = seasonData.episodes.map(ep => ({
        name: ep.name || `Tập ${ep.episode_number}`,
        episode_number: ep.episode_number
      }));
      renderEpisodes();
      episodeSection.style.display = 'block';
    } else {
      episodes = [{ name: 'Phim lẻ' }];
    }
    
    return true;
  } catch (error) {
    console.error('TMDB error:', error);
    showToast('Lỗi tải thông tin TMDB');
    return false;
  }
}

// ==================== RENDER FUNCTIONS ====================
function renderServerControls() {
  serverControls.innerHTML = '';
  
  if (['ax', 'bx', 'cx'].includes(mainSource) && servers.length > 1) {
    servers.forEach((server, index) => {
      const btn = document.createElement('button');
      btn.className = `control-btn ${index === curSrv ? 'active' : ''}`;
      btn.textContent = `${server.name} (${server.data.length})`;
      btn.onclick = () => switchServer(index);
      serverControls.appendChild(btn);
    });
  }
}

function renderEpisodes() {
  epGrid.innerHTML = '';
  
  episodes.forEach((episode, index) => {
    const btn = document.createElement('button');
    btn.className = `ep-btn ${index === curEp ? 'active' : ''}`;
    btn.textContent = episode.name || `Tập ${index + 1}`;
    btn.onclick = () => play(index);
    epGrid.appendChild(btn);
  });
  
  episodeSubtitle.textContent = `Tổng cộng ${episodes.length} tập`;
}

function markEp(index) {
  document.querySelectorAll('.ep-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
}

// ==================== PLAYER FUNCTIONS ====================
function resetPlayer() {
  if (hls) {
    hls.destroy();
    hls = null;
  }
  
  if (timeUpdateHandler) {
    videoEl.removeEventListener('timeupdate', timeUpdateHandler);
    timeUpdateHandler = null;
  }
  
  videoEl.pause();
  videoEl.src = '';
  videoEl.style.display = 'none';
  
  embedFrame.src = '';
  embedFrame.style.display = 'none';
  
  loading.style.display = 'flex';
  errorMsg.style.display = 'none';
  warned = false;
  clearTimeout(popupTimeout);
}

function playEmbed(url) {
  resetPlayer();
  embedFrame.src = url;
  embedFrame.style.display = 'block';
  embedFrame.onload = () => {
    loading.style.display = 'none';
  };
}

function playHLS(m3u8Url) {
  resetPlayer();
  videoEl.style.display = 'block';
  
  if (Hls.isSupported()) {
    hls = new Hls({
      enableWorker: true,
      lowLatencyMode: true,
      backBufferLength: 90
    });
    
    hls.loadSource(m3u8Url);
    hls.attachMedia(videoEl);
    
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      loading.style.display = 'none';
      videoEl.play().catch(() => {});
    });
    
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        showToast('Lỗi phát video');
      }
    });
    
  } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
    videoEl.src = m3u8Url;
    videoEl.addEventListener('loadedmetadata', () => {
      loading.style.display = 'none';
      videoEl.play().catch(() => {});
    });
  } else {
    showToast('Trình duyệt không hỗ trợ phát video này');
    return;
  }

  timeUpdateHandler = () => {
    const currentTime = videoEl.currentTime;
    const duration = videoEl.duration;
    
    if (!warned && duration && currentTime >= duration - 120 && curEp < episodes.length - 1) {
      showEndPopup();
    }
  };
  
  videoEl.addEventListener('timeupdate', timeUpdateHandler);
  videoEl.addEventListener('ended', () => {
    if (curEp < episodes.length - 1 && !warned) {
      nextEp();
    }
  });
}

async function play(index) {
  if (index < 0 || index >= episodes.length) {
    errorMsg.textContent = 'Tập không tồn tại';
    errorMsg.style.display = 'flex';
    loading.style.display = 'none';
    return;
  }

  curEp = index;
  markEp(index);
  updateUrl(index);
  
  titleEl.textContent = `${movie}${type === 'tv' ? ` | Tập ${index + 1}` : ''}`;
  currentEpEl.textContent = type === 'tv' ? `Mùa ${season} - Tập ${index + 1}` : 'Phim lẻ';

  // Handle embed sources (vidlink, videasy, vidsrc)
  if (['vidlink', 'videasy', 'vidsrc'].includes(mainSource)) {
    episode = index + 1;
    let url = '';
    
    if (mainSource === 'vidlink') {
      url = getVidLinkUrl();
    } else if (mainSource === 'videasy') {
      url = getVideasyUrl();
    } else if (mainSource === 'vidsrc') {
      url = await getVidsrcUrl();
    }
    
    playEmbed(url);
    return;
  }

  // Handle local sources (ax, bx, cx)
  const ep = episodes[index];
  const m3u8 = ep.link_m3u8?.trim();
  const embed = ep.link_embed?.trim();

  if (!m3u8 && !embed) {
    errorMsg.textContent = 'Không có link phát';
    errorMsg.style.display = 'flex';
    loading.style.display = 'none';
    return;
  }

  if (mode === 'm3u8' && m3u8 && srcMap[mainSource] !== 'Nguonc') {
    playHLS(m3u8);
    return;
  }

  if (mode === 'embed' && embed) {
    playEmbed(embed);
    return;
  }

  // Fallback
  if (m3u8 && srcMap[mainSource] !== 'Nguonc') {
    playHLS(m3u8);
  } else if (embed) {
    playEmbed(embed);
  } else {
    errorMsg.textContent = 'Không có nguồn phù hợp';
    errorMsg.style.display = 'flex';
    loading.style.display = 'none';
  }
}

function switchServer(index) {
  if (index < 0 || index >= servers.length) return;
  
  curSrv = index;
  episodes = servers[index].data;
  
  renderEpisodes();
  renderServerControls();
  
  curEp = Math.min(curEp, episodes.length - 1);
  play(curEp);
}

function seek(seconds) {
  if (videoEl.style.display !== 'none' && !isNaN(videoEl.duration)) {
    videoEl.currentTime = Math.max(0, Math.min(videoEl.currentTime + seconds, videoEl.duration));
  }
}

function prevEp() {
  if (curEp > 0) {
    play(curEp - 1);
  } else {
    showToast('Đây là tập đầu tiên');
  }
}

function nextEp() {
  if (curEp < episodes.length - 1) {
    play(curEp + 1);
  } else {
    showToast('Đây là tập cuối cùng');
  }
}

// ==================== SOURCE CHANGE HANDLER ====================
async function changeMainSource(sourceCode) {
  if (sourceCode === mainSource) return;
  
  mainSource = sourceCode;
  updateSourceButtons();
  
  resetPlayer();
  loading.style.display = 'flex';
  episodeSection.style.display = 'none';

  if (['vidlink', 'videasy', 'vidsrc'].includes(sourceCode)) {
    if (tmdb) {
      await loadTmdbInfo();
      curEp = epFromUrl();
      play(curEp);
    } else {
      showToast('Cần TMDB ID cho nguồn này');
      // Fallback to bx
      setTimeout(() => changeMainSource('bx'), 1000);
      return;
    }
  } else {
    if (await loadMovie()) {
      curSrv = 0;
      switchServer(0);
      episodeSection.style.display = 'block';
      curEp = epFromUrl();
      play(curEp);
    } else {
      showToast('Thử nguồn khác...');
    }
  }
  
  updateUrl(curEp);
}

// ==================== EVENT LISTENERS ====================
// Source selection
sourceSelector.addEventListener('click', (e) => {
  if (e.target.classList.contains('source-btn')) {
    changeMainSource(e.target.dataset.src);
  }
});

// Mode selection
modeControls.addEventListener('click', (e) => {
  if (e.target.classList.contains('control-btn') && e.target.dataset.mode) {
    mode = e.target.dataset.mode;
    updateModeButtons();
    if (episodes.length > 0) {
      play(curEp);
    }
  }
});

// Popup handlers
popupYes.onclick = () => {
  clearTimeout(popupTimeout);
  popup.classList.remove('show');
  warned = false;
  nextEp();
};

popupNo.onclick = () => {
  clearTimeout(popupTimeout);
  popup.classList.remove('show');
  warned = true;
};

// ==================== INITIALIZATION ====================
async function init() {
  if (!tmdb && (!slug || slug === 'null')) {
    errorMsg.textContent = 'Thiếu thông tin phim (tmdb hoặc slug)';
    errorMsg.style.display = 'flex';
    return;
  }

  curEp = epFromUrl();
  loading.style.display = 'flex';
  updateSourceButtons();
  updateModeButtons();

  // Initialize based on source type
  if (['vidlink', 'videasy', 'vidsrc'].includes(mainSource)) {
    if (tmdb) {
      await loadTmdbInfo();
    } else {
      showToast('TMDB ID bị thiếu');
      mainSource = 'bx';
      changeMainSource('bx');
      return;
    }
  } else {
    if (!await loadMovie()) {
      // Try fallback sources
      if (slug && slug !== 'null') {
        for (const source of ['bx', 'ax', 'cx']) {
          if (source !== mainSource) {
            showToast(`Thử nguồn ${source.toUpperCase()}...`);
            if (await loadMovie()) {
              mainSource = source;
              updateSourceButtons();
              break;
            }
          }
        }
      }
    }
    
    if (servers.length > 0) {
      episodeSection.style.display = 'block';
      switchServer(0);
    }
  }

  play(curEp);
}

// Start the application
init();
</script>
</body>
</html>