<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phim Nh√† B√°nh M√¨ - Xem Phim Online</title>
<style>
  :root {
    --primary: #e50914;
    --bg-dark: #0f0f0f;
    --card-bg: #1a1a1a;
    --text: #fff;
    --text-muted: #aaa;
    --border: #333;
    --neon-glow: 0 0 12px rgba(229, 9, 20, 0.6), 0 0 20px rgba(229, 9, 20, 0.4);
    --transition: all 0.3s ease;
    --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
    --shadow-lg: 0 16px 40px rgba(0,0,0,0.6);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { background-color: #121212; color: var(--text); line-height: 1.5; overflow-x: hidden; }
  header { background-color: #040303; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
  nav { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; gap: 20px; flex-wrap: wrap; }
  .logo { font-size: 26px; font-weight: bold; color: var(--primary); text-shadow: 0 0 8px rgba(229, 9, 20, 0.5); }
  .search-bar { flex: 1; max-width: 500px; position: relative; display: flex; align-items: center; }
  .search-bar input { flex: 1; padding: 10px 40px 10px 15px; border: none; border-radius: 8px; background: var(--border); color: var(--text); font-size: 14px; transition: var(--transition); }
  .search-bar input:focus { outline: none; background: #444; box-shadow: 0 0 0 2px var(--primary); }
  .search-bar input::placeholder { color: var(--text-muted); }
  .search-bar button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--primary); font-size: 18px; cursor: pointer; padding: 5px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
  .nav-links { display: flex; gap: 25px; align-items: center; flex-wrap: wrap; }
  .nav-links a, .nav-links .dropdown-toggle { color: var(--text); text-decoration: none; font-weight: 500; font-size: 15px; transition: color 0.3s; position: relative; padding: 4px 0; }
  .nav-links a:hover, .dropdown-toggle:hover { color: var(--primary); }
  .dropdown-toggle::after { content: '‚ñº'; font-size: 10px; margin-left: 4px; opacity: 0.7; transition: var(--transition); }
  .dropdown-toggle:hover::after { opacity: 1; transform: translateY(1px); }

  /* DROPDOWN */
  .dropdown { position: relative; }
  .dropdown-content {
    position: absolute;
    top: 100%; left: 50%; transform: translateX(-50%);
    background: var(--card-bg);
    min-width: 220px;
    max-height: 65vh;
    overflow-y: auto;
    border-radius: 12px;
    box-shadow: var(--shadow-lg), 0 0 20px rgba(229,9,20,0.5);
    z-index: 999;
    padding: 12px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.25s ease, visibility 0.25s ease, transform 0.25s ease;
    transform: translateX(-50%) translateY(-8px);
    border: 1px solid var(--primary);
  }
  .dropdown:hover .dropdown-content,
  .dropdown:focus-within .dropdown-content {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translateX(-50%) translateY(0);
  }
  .dropdown-item {
    padding: 10px 14px;
    font-size: 13.5px;
    color: var(--text);
    cursor: pointer;
    border-radius: 8px;
    transition: var(--transition);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .dropdown-item:hover {
    background: var(--primary);
    color: #fff;
    transform: translateY(-2px);
  }

  .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
  .section-title { font-size: 22px; margin-bottom: 15px; font-weight: 600; color: var(--primary); text-shadow: 0 0 8px rgba(229, 9, 20, 0.5); position: relative; padding-left: 12px; }
  .section-title::before { content: ''; position: absolute; left: 0; top: 50%; width: 4px; height: 20px; background: var(--primary); border-radius: 2px; transform: translateY(-50%); }

  .movie-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap: 18px; 
    padding: 16px 8px; 
    touch-action: pan-y; 
    -webkit-overflow-scrolling: touch;
  }
  .movie-card {
    background: var(--card-bg); 
    border-radius: 14px; 
    overflow: hidden; 
    cursor: pointer;
    transition: var(--transition); 
    position: relative; 
    border: 2px solid transparent;
    box-shadow: var(--shadow-sm);
  }
  .movie-card::before {
    content: ''; 
    position: absolute; 
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    background: linear-gradient(45deg, var(--primary), #ff4d4d, #ff6b6b, var(--primary)); 
    border-radius: 16px;
    z-index: -1; 
    opacity: 0; 
    transition: opacity 0.4s ease;
    filter: blur(1px);
  }
  .movie-card:hover::before { opacity: 1; }
  .movie-card:hover { 
    transform: translateY(-14px) scale(1.03); 
    z-index: 10; 
    box-shadow: 0 0 35px rgba(229, 9, 20, 0.9), var(--shadow-lg); 
  }
  .movie-card img {
    width: 100%; 
    aspect-ratio: 2 / 3;
    object-fit: cover; 
    display: block; 
    border-radius: 12px 12px 0 0;
    background: #111;
    transition: filter 0.3s;
    filter: brightness(0.9);
    loading: lazy;
  }
  .movie-card:hover img { filter: brightness(1); }
  .movie-info { padding: 14px; background: linear-gradient(transparent, var(--card-bg)); }
  .movie-title { font-weight: 600; font-size: 14.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); margin-bottom: 4px; }
  .movie-episode { font-size: 12.5px; color: var(--primary); margin: 4px 0; font-weight: 600; text-shadow: 0 0 6px rgba(229, 9, 20, 0.4); }
  .movie-source { font-size: 10.5px; color: #888; font-weight: bold; text-transform: uppercase; letter-spacing: 0.6px; }

  .pagination { display: flex; justify-content: center; gap: 10px; margin: 35px 0; flex-wrap: wrap; }
  .page-btn {
    min-width: 40px; height: 40px; background: var(--card-bg); color: var(--text);
    border: 1.5px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14.5px;
    font-weight: 500; transition: var(--transition);
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 0 14px rgba(229, 9, 20, 0.7); font-weight: 600; }
  .page-btn:hover:not(.active) { background: #333; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(229,9,20,0.3); }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 50px;
    font-size: 17px;
    color: var(--text-muted);
    position: relative;
  }
  .loading::after {
    content: ''; width: 32px; height: 32px; border: 3px solid #333; border-top: 3px solid var(--primary);
    border-radius: 50%; display: inline-block; margin-left: 12px; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 480px) {
    .search-bar { flex: 1; max-width: 200px; margin-left: 8px; }
    .search-bar input { padding: 8px 32px 8px 10px; font-size: 13px; border-radius: 6px; }
    .search-bar button { width: 32px; height: 32px; font-size: 16px; }
    .nav-links { gap: 8px; font-size: 13px; }
    .dropdown-content { 
      position: fixed; 
      top: 50% !important; left: 50% !important; 
      transform: translate(-50%, -50%) !important; 
      width: 90vw; max-width: 340px; 
      max-height: 70vh; 
      grid-template-columns: 1fr; 
    }
  }
  @media (min-width: 1200px) {
    .movie-grid { grid-template-columns: repeat(6, 1fr); gap: 20px; }
    .movie-card img { height: 300px; }
    .movie-title { font-size: 15px; }
    .movie-episode { font-size: 13px; }
  }
  @media (max-width: 1400px) { .movie-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 1100px) { .movie-grid { grid-template-columns: repeat(4, 1fr); } }
  @media (max-width: 900px) { 
    .search-bar { display: flex !important; flex: 1; max-width: 300px; }
    .nav-links { gap: 18px; font-size: 14px; }
    .logo { font-size: 24px; }
  }
  @media (max-width: 768px) {
    nav { padding: 0 15px; gap: 15px; }
    .dropdown-content { grid-template-columns: 1fr; }
  }
  @media (max-width: 500px) {
    .movie-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; padding: 12px; }
    .section-title { font-size: 20px; }
  }
</style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">Phim Nh√† B√°nh M√¨</div>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Nh·∫≠p t·ª´ kh√≥a kh√¥ng d·∫•u" />
        <button id="search-btn">üï∂</button>
      </div>
      <div class="nav-links">
        <a href="#" id="home-link">Trang ch·ªß</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Th·ªÉ lo·∫°i</a>
          <div class="dropdown-content" id="genre-list"></div>
        </div>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Qu·ªëc gia</a>
          <div class="dropdown-content" id="country-list"></div>
        </div>
        <a href="#" id="phim-bo">Phim B·ªô</a>
        <a href="#" id="phim-le">Phim L·∫ª</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">NƒÉm</a>
          <div class="dropdown-content" id="year-list"></div>
        </div>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Danh S√°ch</a>
          <div class="dropdown-content" id="cutee-list"></div>
        </div>       
        <a href="#" id="phim-chieu-rap">Cinemax</a>
      </div>
    </nav>
  </header>
  <div class="container"></div>

<script>
  // SLUG MAP
  const GENRE_SLUG_MAP = { 'H√†nh ƒê·ªông': 'hanh-dong', 'Phi√™u L∆∞u': 'phieu-luu', 'Ho·∫°t H√¨nh': 'hoat-hinh', 'H√†i': 'phim-hai', 'H√†i H∆∞·ªõc': 'hai-huoc', 'H√¨nh S·ª±': 'hinh-su', 'T√†i Li·ªáu': 'tai-lieu', 'Ch√≠nh K·ªãch': 'chinh-kich', 'Gia ƒê√¨nh': 'gia-dinh', 'Gi·∫£ T∆∞·ªüng': 'gia-tuong', 'L·ªãch S·ª≠': 'lich-su', 'Kinh D·ªã': 'kinh-di', 'Nh·∫°c': 'am-nhac', '√Çm Nh·∫°c': 'am-nhac', 'B√≠ ·∫®n': 'bi-an', 'L√£ng M·∫°n': 'lang-man', 'T√¨nh C·∫£m': 'tinh-cam', 'Khoa H·ªçc Vi·ªÖn T∆∞·ªüng': 'khoa-hoc-vien-tuong', 'G√¢y C·∫•n': 'gay-can', 'Chi·∫øn Tranh': 'chien-tranh', 'T√¢m L√Ω': 'tam-ly', 'C·ªï Trang': 'co-trang', 'Mi·ªÅn T√¢y': 'mien-tay', 'Phim 18+': 'phim-18', 'Th·ªÉ Thao': 'the-thao', 'V√µ Thu·∫≠t': 'vo-thuat', 'Vi·ªÖn T∆∞·ªüng': 'vien-tuong', 'Khoa H·ªçc': 'khoa-hoc', 'Th·∫ßn Tho·∫°i': 'than-thoai', 'H·ªçc ƒê∆∞·ªùng': 'hoc-duong', 'Kinh ƒêi·ªÉn': 'kinh-dien' };
  const COUNTRY_SLUG_MAP = { '√Çu M·ªπ': 'au-my', 'H√†n Qu·ªëc': 'han-quoc', 'Trung Qu·ªëc': 'trung-quoc', 'Nh·∫≠t B·∫£n': 'nhat-ban', 'Th√°i Lan': 'thai-lan', 'H·ªìng K√¥ng': 'hong-kong', '·∫§n ƒê·ªô': 'an-do', 'Anh': 'anh', 'Ph√°p': 'phap', 'Canada': 'canada', 'ƒê·ª©c': 'duc', 'T√¢y Ban Nha': 'tay-ban-nha', '√öc': 'uc', '√ù': 'y', 'H√† Lan': 'ha-lan', 'Indonesia': 'indonesia', 'Nga': 'nga', 'Mexico': 'mexico', 'Ba Lan': 'ba-lan', 'Malaysia': 'malaysia', 'B·ªì ƒê√†o Nha': 'bo-dao-nha', 'Th·ª•y ƒêi·ªÉn': 'thuy-dien', 'Philippines': 'philippines', 'ƒêan M·∫°ch': 'dan-mach', 'Th·ª•y Sƒ©': 'thuy-si', 'Ukraina': 'ukraina', 'UAE': 'uae', '·∫¢ R·∫≠p X√™ √öt': 'a-rap-xe-ut', 'Th·ªï Nhƒ© K·ª≥': 'tho-nhi-ky', 'Brazil': 'brazil', 'Na Uy': 'na-uy', 'Nam Phi': 'nam-phi', 'Vi·ªát Nam': 'viet-nam', 'ƒê√†i Loan': 'dai-loan', 'Ch√¢u Phi': 'chau-phi', 'B·ªâ': 'bi', 'Ireland': 'ireland', 'Colombia': 'colombia', 'Ph·∫ßn Lan': 'phan-lan', 'Chile': 'chile', 'Hy L·∫°p': 'hy-lap', 'Nigeria': 'nigeria', 'Argentina': 'argentina', 'Singapore': 'singapore', 'Qu·ªëc Gia Kh√°c': 'quoc-gia-khac' };
  const TYPE_MAP = { 'phim-bo': 'phim-bo', 'phim-le': 'phim-le', 'thuyet-minh': 'phim-thuyet-minh', 'chieu-rap': 'phim-chieu-rap' };
  const CUTEE_MENU = { 'Phim m·ªõi': { mode: 'default' }, 'Phim b·ªô': { mode: 'type', filter: 'phim-bo' }, 'Phim l·∫ª': { mode: 'type', filter: 'phim-le' }, 'Shows': { mode: 'cutee', slug: 'tv-shows' }, 'Ho·∫°t h√¨nh': { mode: 'cutee', slug: 'hoat-hinh' }, 'Phim vietsub': { mode: 'cutee', slug: 'vietsub' }, 'Phim thuy·∫øt minh': { mode: 'cutee', slug: 'thuyet-minh' }, 'Phim l·ªìng ti·∫øng': { mode: 'cutee', slug: 'long-tieng' }, 'Phim b·ªô ƒëang chi·∫øu': { mode: 'cutee', slug: 'phim-dang-chieu' }, 'Phim b·ªô ƒë√£ ho√†n th√†nh': { mode: 'cutee', slug: 'hoan-tat' }, 'Phim s·∫Øp chi·∫øu': { mode: 'cutee', slug: 'phim-sap-chieu' }, 'Subteam': { mode: 'cutee', slug: 'subteam' }, 'Phim chi·∫øu r·∫°p': { mode: 'cutee', slug: 'phim-chieu-rap' } };

  // C·∫§U H√åNH NGU·ªíN API
  const API_SOURCES = {
    Ophim: { 
      name: 'Ophim', code: 'ax', 
      defaultUrl: p => `?page=${p}`, 
      genreUrl: (slug, p) => `https://ophim1.com/v1/api/danh-sach/${slug}?page=${p}`, 
      genreUrlTheLoai: (slug, p) => `https://ophim1.com/v1/api/the-loai/${slug}?page=${p}`, 
      countryUrl: (slug, p) => `https://ophim1.com/v1/api/quoc-gia/${slug}?page=${p}`, 
      yearUrl: (year, p) => `https://ophim1.com/v1/api/nam-phat-hanh/${year}?page=${p}`, 
      typeUrl: (type, p) => `https://ophim1.com/v1/api/danh-sach/${type}?page=${p}`, 
      cuteeUrl: (slug, p) => `https://ophim1.com/v1/api/danh-sach/${slug}?page=${p}`, 
      searchUrl: slug => `https://ophim1.com/v1/api/phim/${slug}`, 
      keywordSearchUrl: (kw, p = 1) => `https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(kw)}&page=${p}`, 
      parser: d => d?.data?.items || [], 
      searchParser: d => d?.data?.item ? [d.data.item] : [], 
      keywordParser: d => d?.data?.items || [], 
      getCdn: () => 'https://img.ophim.live/uploads/movies/' 
    },
    Phimapi: { 
      name: 'Phimapi', code: 'bx', 
      defaultUrl: p => `https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=${p}`, 
      genreUrl: (slug, p) => `https://phimapi.com/v1/api/danh-sach/${slug}?page=${p}`, 
      genreUrlTheLoai: (slug, p) => `https://phimapi.com/v1/api/the-loai/${slug}?page=${p}`, 
      countryUrl: (slug, p) => `https://phimapi.com/v1/api/quoc-gia/${slug}?page=${p}`, 
      yearUrl: (year, p) => `https://phimapi.com/v1/api/nam/${year}?page=${p}`, 
      typeUrl: (type, p) => `https://phimapi.com/v1/api/danh-sach/${type}?page=${p}`, 
      cuteeUrl: (slug, p) => `https://phimapi.com/v1/api/danh-sach/${slug}?page=${p}`, 
      searchUrl: slug => `https://phimapi.com/phim/${slug}`, 
      keywordSearchUrl: (kw, p = 1) => `https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(kw)}&page=${p}`, 
      parser: d => d?.data?.items || d?.items || [], 
      searchParser: d => d?.movie ? [d.movie] : [], 
      keywordParser: d => d?.data?.items || [], 
      getCdn: d => (d?.data?.APP_DOMAIN_CDN_IMAGE || 'https://phimimg.com/').replace(/\/+$/, '') + '/' 
    },
    Nguonc: { 
      name: 'Nguonc', code: 'cx', 
      defaultUrl: p => `https://phim.nguonc.com/api/films/phim-moi-cap-nhat?page=${p}`, 
      genreUrl: (slug, p) => `https://phim.nguonc.com/api/films/danh-sach/${slug}?page=${p}`, 
      countryUrl: (slug, p) => `https://phim.nguonc.com/api/films/quoc-gia/${slug}?page=${p}`, 
      yearUrl: (year, p) => `https://phim.nguonc.com/api/films/nam-phat-hanh/${year}?page=${p}`, 
      typeUrl: (type, p) => `https://phim.nguonc.com/api/films/danh-sach/${type}?page=${p}`, 
      cuteeUrl: (slug, p) => { 
        const map = { 'tv-shows': 'tv-shows', 'dang-chieu': 'phim-dang-chieu', 'hoat-hinh': 'hoat-hinh' }; 
        return `https://phim.nguonc.com/api/films/danh-sach/${map[slug] || slug}?page=${p}`;
      }, 
      searchUrl: slug => `https://phim.nguonc.com/api/film/${slug}`, 
      keywordSearchUrl: (kw, p = 1) => `https://phim.nguonc.com/api/films/search?keyword=${encodeURIComponent(kw)}&page=${p}`, 
      parser: d => d?.items || [], 
      searchParser: d => d?.movie ? [d.movie] : [], 
      keywordParser: d => d?.items || [], 
      getCdn: () => 'https://phim.nguonc.com/public/images/Post/' 
    }
  };

  const ITEMS_PER_PAGE = 10;
  let currentMode = 'default', currentFilter = null, currentPage = 1;
  let currentSearchQuery = '';
  const imageCache = new Map();

  // H·ªÜ TH·ªêNG CACHE 12 TI·∫æNG
  const CACHE_TTL = 12 * 60 * 60 * 1000;
  function getCacheKey(sourceName, mode, filter, page, isSearch = false, isKeyword = false) {
    if (isKeyword) return `cache|keyword|${sourceName}|${filter}|${page || 1}`;
    if (isSearch) return `cache|search|${sourceName}|${filter}`;
    return `cache|${sourceName}|${mode}|${filter || 'default'}|${page || 1}`;
  }
  function getCache(key) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const cached = JSON.parse(raw);
      if (Date.now() - cached.timestamp > CACHE_TTL) {
        localStorage.removeItem(key);
        return null;
      }
      return cached.data;
    } catch (e) {
      console.warn('L·ªói ƒë·ªçc cache:', e);
      return null;
    }
  }
  function setCache(key, data) {
    try {
      const toStore = { data, timestamp: Date.now() };
      localStorage.setItem(key, JSON.stringify(toStore));
    } catch (e) {
      console.warn('L·ªói l∆∞u cache:', e);
      clearOldCache();
    }
  }
  function clearOldCache() {
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const key = localStorage.key(i);
      if (key?.startsWith('cache|')) {
        try {
          const raw = localStorage.getItem(key);
          const cached = JSON.parse(raw);
          if (Date.now() - cached.timestamp > CACHE_TTL) {
            localStorage.removeItem(key);
          }
        } catch {}
      }
    }
  }

  // H√ÄM ƒê·∫æM S·ªê T·∫¨P
  function getEpisodeDisplay(item) {
    if (!item) return '';
    const movie = item.movie || item;
    const episodes = item.episodes || movie.episodes;
    if ( (!movie.episode_current && !movie.current_episode) && (!movie.episode_total && !movie.total_episodes) && !Array.isArray(episodes) ) {
      const type = movie.type || movie.tmdb?.type;
      return type === 'tv' ? 'Phim b·ªô' : 'Phim l·∫ª';
    }
    let current = '', total = '', links = 0;
    const currStr = movie.episode_current || movie.current_episode || '';
    const totalStr = movie.episode_total || movie.total_episodes || '';
    const currMatch = currStr.match(/T·∫≠p (\d+)/i) || currStr.match(/(\d+)/);
    if (currMatch) current = currMatch[1];
    if (totalStr) total = totalStr;
    if (Array.isArray(episodes)) {
      episodes.forEach(server => {
        const data = server.server_data || server.items || [];
        if (Array.isArray(data)) links += data.length;
      });
    }
    let display = '';
    if (current && total) display = `T·∫≠p ${current}/${total}`;
    else if (current) display = `T·∫≠p ${current}`;
    else if (/full|ho√†n t·∫•t|ho√†n th√†nh/i.test(currStr)) display = 'Ho√†n t·∫•t';
    else display = 'ƒêang ph√°t';
    if (links > 0) display += ` (${links} link)`;
    return display;
  }

  // DOM READY
  document.addEventListener('DOMContentLoaded', () => {
    renderDropdowns();
    initYearDropdown();
    attachNavEvents();
    loadContent('default');
    loadCustomMenu();

    // CH·ªà CH·∫∂N CHU·ªòT PH·∫¢I TR√äN index.html
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
  });

  // RENDER DROPDOWNS
  function renderDropdowns() {
    renderGenreDropdown();
    renderCountryDropdown();
    renderCuteeDropdown();
  }
  function renderGenreDropdown() {
    const list = document.getElementById('genre-list');
    list.innerHTML = '';
    Object.keys(GENRE_SLUG_MAP).forEach(key => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = key;
      item.dataset.slug = GENRE_SLUG_MAP[key];
      item.dataset.mode = 'genre';
      list.appendChild(item);
    });
  }
  function renderCountryDropdown() {
    const list = document.getElementById('country-list');
    list.innerHTML = '';
    Object.keys(COUNTRY_SLUG_MAP).forEach(key => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = key;
      item.dataset.slug = COUNTRY_SLUG_MAP[key];
      item.dataset.mode = 'country';
      list.appendChild(item);
    });
  }
  function renderCuteeDropdown() {
    const list = document.getElementById('cutee-list');
    list.innerHTML = '';
    Object.keys(CUTEE_MENU).forEach(label => {
      const cfg = CUTEE_MENU[label];
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = label;
      item.dataset.mode = cfg.mode;
      if (cfg.slug) item.dataset.slug = cfg.slug;
      if (cfg.filter) item.dataset.filter = cfg.filter;
      list.appendChild(item);
    });
  }
  function initYearDropdown() {
    const yearList = document.getElementById('year-list');
    yearList.innerHTML = '';
    for (let y = 2028; y >= 1969; y--) {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = y;
      item.dataset.year = y;
      item.dataset.mode = 'year';
      yearList.appendChild(item);
    }
  }

  // EVENT LISTENERS
  function attachNavEvents() {
    document.getElementById('home-link').onclick = e => { e.preventDefault(); loadContent('default'); };
    document.getElementById('phim-bo').onclick = e => { e.preventDefault(); loadContent('type', 'phim-bo', 1); };
    document.getElementById('phim-le').onclick = e => { e.preventDefault(); loadContent('type', 'phim-le', 1); };
    document.getElementById('phim-chieu-rap').onclick = e => { e.preventDefault(); loadContent('cutee', 'phim-chieu-rap', 1); };
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    searchBtn.onclick = search;
    searchInput.addEventListener('keypress', ev => ev.key === 'Enter' && search());
    searchInput.addEventListener('input', () => {
      if (!searchInput.value.trim()) loadContent('default');
    });
  }

  // SECTION MANAGEMENT
  function createSection(id, title) {
    const sec = document.createElement('div');
    sec.id = id;
    sec.innerHTML = ` 
      <div class="section-title">${title}</div> 
      <div class="movie-grid" id="${id}-grid"></div> 
      <div class="pagination" id="${id}-pagination"></div> 
    `;
    return sec;
  }
  function showSection(section) {
    document.querySelectorAll('.container > div[id$="-section"]').forEach(s => { s.style.display = 'none'; });
    const container = document.querySelector('.container');
    if (!container) return console.error('Kh√¥ng c√≥ .container!');
    const existing = document.getElementById(section.id);
    if (existing) {
      existing.style.display = 'block';
      container.insertBefore(existing, container.firstChild);
    } else {
      container.insertBefore(section, container.firstChild);
      section.style.display = 'block';
    }
  }

  // PRELOAD IMAGE
  function preloadImage(src) {
    if (imageCache.has(src)) return imageCache.get(src);
    const img = new Image();
    img.decoding = 'async';
    img.src = src;
    imageCache.set(src, img);
    return img;
  }

  // FETCH CHUNG
  async function fetchFromSource(source, page, mode, filter, isSearch = false, isKeyword = false) {
    const cacheKey = getCacheKey(source.name, mode, filter, page, isSearch, isKeyword);
    const cached = getCache(cacheKey);
    if (cached) {
      console.log(`[CACHE HIT] ${cacheKey}`);
      return cached.map(m => ({ ...m, sourceCode: source.code, sourceName: source.name })); // ƒê·∫£m b·∫£o sourceCode v√† sourceName
    }

    let urls = [];
    if (isKeyword) {
      urls.push(source.keywordSearchUrl(filter, page));
    } else if (isSearch) {
      urls.push(source.searchUrl(filter));
    } else if (mode === 'genre') {
      if (source.genreUrlTheLoai) {
        urls.push(source.genreUrlTheLoai(filter, page));
      } else {
        urls.push(source.genreUrl(filter, page));
      }
    } else if (mode === 'cutee' || mode === 'type') {
      const slug = filter || '';
      urls.push(source.cuteeUrl?.(slug, page) || source.genreUrl(filter, page));
    } else if (mode === 'country') {
      urls.push(source.countryUrl(filter, page));
    } else if (mode === 'year') {
      urls.push(source.yearUrl(filter, page));
    } else {
      urls.push(source.defaultUrl(page));
    }

    const fetchPromises = urls.map(async (url) => {
      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) return null;
        const data = await res.json();
        const parser = isKeyword ? (source.keywordParser || source.parser) : 
                      isSearch ? (source.searchParser || source.parser) : source.parser;
        const items = parser(data) || [];
        if (items.length > 0) {
          return { data, items, cdn: typeof source.getCdn === 'function' ? source.getCdn(data) : source.getCdn() };
        }
        return null;
      } catch (e) {
        console.warn(`[${source.name}] L·ªói URL: ${url}`, e.message);
        return null;
      }
    });

    const results = await Promise.all(fetchPromises);
    const valid = results.find(r => r !== null);
    if (!valid) return [];

    const processed = valid.items.map(item => {
      let thumb = '';
      if (source.name === 'Phimapi') {
        thumb = item.poster_url || item.poster || item.thumb_url || item.thumb || '';
      } else {
        thumb = item.thumb_url || item.thumb || item.poster_url || item.poster || '';
      }
      if (thumb && !thumb.startsWith('http') && !thumb.startsWith('//')) {
        thumb = valid.cdn + thumb.replace(/^\/+/, '');
      }
      return {
        name: item.name || item.origin_name || item.title || 'Kh√¥ng r√µ',
        thumb_url: thumb || 'https://via.placeholder.com/200x300/333/fff?text=No+Image',
        episodeDisplay: getEpisodeDisplay(item),
        slug: item.slug || '',
        sourceCode: source.code,
        sourceName: source.name,
        isSlugSearch: isSearch
      };
    }).filter(m => m.slug);

    setCache(cacheKey, processed);
    console.log(`[CACHE SET] ${cacheKey}`);
    return processed;
  }

  // XEN K·∫º NGU·ªíN - ∆ØU TI√äN SLUG SEARCH, XEN K·∫º 3 NGU·ªíN
  function interleaveSourcesProperly(results, isSearch = false) {
    // Ph√¢n lo·∫°i slug v√† keyword t·ª´ t·∫•t c·∫£ ngu·ªìn
    const slugResults = [];
    const keywordResults = [];
    results.forEach(arr => {
      if (arr.length > 0 && arr[0].isSlugSearch) {
        slugResults.push(arr);
      } else {
        keywordResults.push(arr);
      }
    });

    // Xen k·∫Ω 3 ngu·ªìn cho slug
    const seen = new Set();
    const final = [];
    const numSources = slugResults.length;
    let indices = new Array(numSources).fill(0);
    while (final.length < ITEMS_PER_PAGE) {
      let added = false;
      for (let i = 0; i < numSources; i++) {
        if (indices[i] < slugResults[i].length) {
          const m = slugResults[i][indices[i]];
          if (!seen.has(m.slug)) {
            seen.add(m.slug);
            final.push(m);
            added = true;
            indices[i]++;
            if (final.length >= ITEMS_PER_PAGE) break;
          } else {
            indices[i]++;
          }
        }
      }
      if (!added) break;
    }

    // Xen k·∫Ω 3 ngu·ªìn cho keyword n·∫øu c√≤n ch·ªó
    indices = new Array(keywordResults.length).fill(0);
    while (final.length < ITEMS_PER_PAGE) {
      let added = false;
      for (let i = 0; i < keywordResults.length; i++) {
        if (indices[i] < keywordResults[i].length) {
          const m = keywordResults[i][indices[i]];
          if (!seen.has(m.slug)) {
            seen.add(m.slug);
            final.push(m);
            added = true;
            indices[i]++;
            if (final.length >= ITEMS_PER_PAGE) break;
          } else {
            indices[i]++;
          }
        }
      }
      if (!added) break;
    }

    return final;
  }

  // LOAD CONTENT
  async function loadContent(mode, filter = null, page = 1) {
    currentMode = mode;
    currentFilter = filter;
    currentPage = page;
    if (mode === 'default') {
      const sectionId = 'default-section';
      let section = document.getElementById(sectionId);
      if (!section) {
        section = createSection(sectionId, 'PHIM M·ªöI NH√Ä B√ÅNH M√å');
        const container = document.querySelector('.container');
        container.insertBefore(section, container.firstChild);
      }
      showSection(section);
      const grid = document.getElementById(`${sectionId}-grid`);
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#aaa;padding:40px;"> Trang ch·ªß </div>';
      const pagination = document.getElementById(`${sectionId}-pagination`);
      if (pagination) pagination.style.display = 'none';
      section.scrollIntoView({ behavior: 'smooth' });
      return;
    }

    const title = getTitle(mode, filter);
    const sectionId = `${mode}-${filter || ''}-section`.replace(/--/g, '-');
    let section = document.getElementById(sectionId);
    if (!section) section = createSection(sectionId, title);
    else section.querySelector('.section-title').textContent = title;
    showSection(section);

    const grid = document.getElementById(`${sectionId}-grid`);
    grid.innerHTML = '<div class="loading">ƒêang t·∫£i ngu·ªìn...</div>';

    const sources = Object.values(API_SOURCES);
    const promises = sources.map(s => fetchFromSource(s, page, mode, filter, false, false));
    const allResults = await Promise.all(promises);
    const movies = interleaveSourcesProperly(allResults, false);

    grid.innerHTML = '';
    if (movies.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#aaa;padding:40px;">Kh√¥ng c√≥ phim n√†o!</div>';
    } else {
      renderMoviesFinal(movies, grid);
    }
    renderPagination(page, sectionId, movies.length >= ITEMS_PER_PAGE);
    section.scrollIntoView({ behavior: 'smooth' });
  }

  function getTitle(mode, filter) {
    if (mode === 'default') return 'PHIM M·ªöI NH√Ä B√ÅNH M√å';
    if (mode === 'genre') return `TH·ªÇ LO·∫†I: ${getDisplayName(filter, GENRE_SLUG_MAP).toUpperCase()}`;
    if (mode === 'country') return `QU·ªêC GIA: ${getDisplayName(filter, COUNTRY_SLUG_MAP).toUpperCase()}`;
    if (mode === 'year') return `NƒÇM: ${filter}`;
    if (mode === 'type') return { 'phim-bo': 'PHIM B·ªò', 'phim-le': 'PHIM L·∫∫' }[filter] || filter.toUpperCase();
    if (mode === 'cutee') {
      const label = Object.keys(CUTEE_MENU).find(k => CUTEE_MENU[k].slug === filter || CUTEE_MENU[k].filter === filter);
      return label?.toUpperCase() || filter.toUpperCase().replace(/-/g, ' ');
    }
    return filter?.toUpperCase() || 'PHIM';
  }
  function getDisplayName(slug, map) {
    return Object.keys(map).find(k => map[k] === slug) || slug;
  }

  // RENDER CARD
  function renderMoviesFinal(movies, container) {
    container.innerHTML = '';
    movies.forEach(m => container.appendChild(createMovieCard(m)));
  }
  function createMovieCard(m) {
    const card = document.createElement('div');
    card.className = 'movie-card';
    card.dataset.slug = m.slug;
    card.dataset.source = m.sourceCode;
    card.onclick = () => location.href = `detail.html?slug=${m.slug}&source=${m.sourceCode}`;

    const img = document.createElement('img');
    img.alt = m.name;
    img.loading = 'lazy';
    img.decoding = 'async';
    img.style.cssText = 'width:100%;height:280px;object-fit:cover;border-radius:10px 10px 0 0;display:block;background:#111;';
    preloadImage(m.thumb_url);
    img.src = m.thumb_url;
    img.onerror = () => img.src = 'https://via.placeholder.com/200x300/333/fff?text=No+Image';

    const sourceMap = { 'ax': 'ADS', 'bx': 'AD', 'cx': 'VIP' };
    const displaySource = sourceMap[m.sourceCode] || 'VIP';

    const info = document.createElement('div');
    info.className = 'movie-info';
    info.innerHTML = ` 
      <div class="movie-title">${m.name}</div> 
      <div class="movie-episode" style="font-weight:600; color:#00ff88;">${m.episodeDisplay}</div> 
      <div class="movie-source">Ngu·ªìn: <strong>${displaySource}</strong></div> 
    `;
    card.append(img, info);
    return card;
  }

  function renderPagination(page, sectionId, hasMore) {
    const el = document.getElementById(`${sectionId}-pagination`);
    if (!el) return;
    el.innerHTML = '';
    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.textContent = '<';
    prev.disabled = page === 1;
    prev.onclick = () => {
      if (currentSearchQuery) search(currentSearchQuery, page - 1);
      else loadContent(currentMode, currentFilter, page - 1);
    };
    el.appendChild(prev);

    for (let i = Math.max(1, page - 4); i <= page + 5; i++) {
      const btn = document.createElement('button');
      btn.className = 'page-btn';
      if (i === page) btn.classList.add('active');
      btn.textContent = i;
      btn.onclick = () => {
        if (currentSearchQuery) search(currentSearchQuery, i);
        else loadContent(currentMode, currentFilter, i);
      };
      el.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = 'page-btn';
    next.textContent = '>';
    next.disabled = !hasMore;
    next.onclick = () => {
      if (currentSearchQuery) search(currentSearchQuery, page + 1);
      else loadContent(currentMode, currentFilter, page + 1);
    };
    el.appendChild(next);
  }

  // T√åM KI·∫æM THEO T·ª™ KH√ìA + SLUG
  async function search(query = null, page = 1) {
    const raw = (query || document.getElementById('search-input').value).trim();
    if (!raw) return loadContent('default');

    currentSearchQuery = raw;
    currentPage = page;

    const sectionId = 'search-section';
    let section = document.getElementById(sectionId);
    if (!section) section = createSection(sectionId, `T√åM: "${raw}"`);
    else section.querySelector('.section-title').textContent = `T√åM: "${raw}"`;
    showSection(section);

    const grid = document.getElementById(`${sectionId}-grid`);
    grid.innerHTML = '<div class="loading">ƒêang t√¨m ki·∫øm t·ª´ 3 ngu·ªìn...</div>';

    const sources = Object.values(API_SOURCES);
    const slugPromises = sources.map(s => fetchFromSource(s, page, null, raw, true, false));
    const keywordPromises = sources.map(s => fetchFromSource(s, page, null, raw, false, true));

    const slugResults = await Promise.all(slugPromises);
    const keywordResults = await Promise.all(keywordPromises);
    const allResults = [...slugResults, ...keywordResults];

    const movies = interleaveSourcesProperly(allResults, true);

    grid.innerHTML = '';
    if (movies.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#aaa;padding:40px;">Kh√¥ng t√¨m th·∫•y phim n√†o!</div>';
    } else {
      renderMoviesFinal(movies, grid);
    }
    renderPagination(page, sectionId, movies.length >= ITEMS_PER_PAGE);
    section.scrollIntoView({ behavior: 'smooth' });
  }

  // CUSTOM MENU
  async function loadCustomMenu() {
    console.log('B·∫Øt ƒë·∫ßu load custom-menu.txt...');
    try {
      const res = await fetch('custom-menu.txt?t=' + Date.now());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if (!text.trim()) throw new Error('File tr·ªëng');
      const groups = parseCustomMenuWithGroups(text);
      console.log('NH√ìM T·∫¢I XONG:', Object.keys(groups));
      clearOldCache();
      for (const [groupName, items] of Object.entries(groups)) {
        if (items.length === 0) continue;
        await loadCustomGroup(groupName, items);
      }
    } catch (e) {
      console.error('L·ªñI LOAD custom-menu.txt:', e.message);
    }
  }

  function parseCustomMenuWithGroups(text) {
    const lines = text.split('\n');
    const groups = {};
    let currentGroup = null;
    lines.forEach(line => {
      line = line.trim();
      if (!line) return;
      if (line.startsWith('#')) {
        currentGroup = line.substring(1).trim().toUpperCase();
        if (!groups[currentGroup]) groups[currentGroup] = [];
        return;
      }
      if (!currentGroup) return;
      const parts = line.split('|');
      if (parts.length < 2) return;
      const [searchText, sourceKey, displayTitle] = parts.map(p => p.trim());
      const slug = searchText.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').replace(/^-+|-+$/g, '');
      groups[currentGroup].push({ slug: slug, source: sourceKey.toLowerCase(), display: displayTitle || searchText });
    });
    return groups;
  }

  async function loadCustomGroup(groupName, items) {
    const sectionId = `custom-group-${groupName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
    let section = document.getElementById(sectionId);
    if (!section) {
      section = createSection(sectionId, groupName);
    }
    const container = document.querySelector('.container');
    if (!document.getElementById(sectionId)) {
      container.appendChild(section);
    }
    section.style.display = 'block';
    const grid = document.getElementById(`${sectionId}-grid`);
    if (grid.innerHTML && !grid.innerHTML.includes('loading')) return;
    grid.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';

    const allMovies = [];
    for (const item of items) {
      let sources = [];
      const src = Object.values(API_SOURCES).find(s => s.name.toLowerCase() === item.source);
      if (src) sources = [src];
      if (sources.length === 0) continue;
      const results = await Promise.all(sources.map(s => fetchFromSource(s, null, null, item.slug, true, false)));
      const movies = interleaveSourcesProperly(results, true);
      allMovies.push(...movies);
    }

    const seen = new Set();
    const finalMovies = [];
    for (const m of allMovies) {
      if (!seen.has(m.slug) && finalMovies.length < 10000000) {
        seen.add(m.slug);
        finalMovies.push(m);
      }
    }

    grid.innerHTML = '';
    if (finalMovies.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#aaa;padding:40px;">Kh√¥ng t√¨m th·∫•y phim!</div>';
    } else {
      renderMoviesFinal(finalMovies, grid);
    }
    const pagination = document.getElementById(`${sectionId}-pagination`);
    if (pagination) pagination.style.display = 'none';
  }

  // X·ª¨ L√ù CLICK MENU
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('dropdown-item')) return;
    const mode = e.target.dataset.mode;
    const slug = e.target.dataset.slug;
    const filter = e.target.dataset.filter || slug;
    const year = e.target.dataset.year;
    currentSearchQuery = '';
    if (mode === 'default') loadContent('default');
    else if (mode === 'genre') loadContent('genre', filter, 1);
    else if (mode === 'country') loadContent('country', filter, 1);
    else if (mode === 'year') loadContent('year', year, 1);
    else if (mode === 'type') loadContent('type', filter, 1);
    else if (mode === 'cutee') loadContent('cutee', slug || filter, 1);
  });
</script>
</body>
</html>