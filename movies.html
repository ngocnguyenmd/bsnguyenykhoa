<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Movies Của Tôi</title>
    <style>
        /* ==============================
           1. RESET & GLOBAL (SIÊU NHẸ)
           ============================== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: 100%;
        }

        body {
            background-color: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: min(100% - 2rem, 1200px);
            margin-inline: auto;
            padding: 0 1rem;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 2rem; }
        .d-flex { display: flex; }
        .gap-1 { gap: 1rem; }

        /* ==============================
           2. HEADER (CỐ ĐỊNH, KHÔNG LAG)
           ============================== */
        header {
            background: #111;
            color: #fff;
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid #222;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(90deg, #0A1A2A, #0F2A3F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        nav ul {
            display: flex;
            gap: 2rem;
            list-style: none;
            flex-wrap: wrap;
        }

        nav a {
            color: #aaa;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            padding: 0.4rem 0;
            position: relative;
            transition: color 0.2s ease;
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: #0A1A2A;
            transition: width 0.3s ease;
            transform: translateX(-50%);
        }

        nav a:hover {
            color: #0A1A2A;
        }

        nav a:hover::after {
            width: 100%;
        }

        /* ==============================
           3. HERO (NHẸ, KHÔNG LAG)
           ============================== */
        .hero {
            background: 
                linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98)),
                url('hoathinh.jpg') center/cover no-repeat fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 80px;
            position: relative;
        }

        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1;
        }

        .hero > * {
            position: relative;
            z-index: 2;
        }

        .hero h2 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 900;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, #0A1A2A, #0F2A3F, #0A1A2A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 2rem;
            color: #ccc;
        }

        /* ==============================
           4. BUTTONS & SEARCH
           ============================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            padding: 0.7rem 1.4rem;
            background: linear-gradient(135deg, #0A1A2A, #0F2A3F);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .btn:hover {
            background: linear-gradient(135deg, #0F2A3F, #142F47);
            transform: translateY(-1px);
        }

        .search-form {
            display: flex;
            gap: 0.8rem;
            max-width: 600px;
            margin: 0 auto 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .search-form input {
            flex: 1;
            min-width: 220px;
            padding: 0.8rem 1rem;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .search-form input:focus {
            border-color: #0A1A2A;
        }

        /* ==============================
           5. MOVIES GRID & CARD
           ============================== */
        .movies {
            padding: 5rem 0;
            background: #0f0f0f;
        }

        .movies h2 {
            text-align: center;
            margin-bottom: 2.5rem;
            font-size: 2.3rem;
            color: #0A1A2A;
            position: relative;
            font-weight: 800;
        }

        .movies h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 3px;
            background: #0A1A2A;
            border-radius: 2px;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 1.6rem;
            padding: 0 1rem;
        }

        .movie-card {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #222;
            transition: transform 0.25s ease, border-color 0.25s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            contain: layout style paint;
        }

        .movie-card:hover {
            transform: translateY(-6px);
            border-color: #0A1A2A;
            z-index: 2;
        }

        .movie-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 2px solid #0A1A2A;
            transition: transform 0.3s ease;
            image-rendering: -webkit-optimize-contrast;
        }

        .movie-card:hover img {
            transform: scale(1.02);
        }

        .movie-card h3 {
            font-size: 0.9rem;
            margin: 0.7rem 0.6rem 0.3rem;
            color: #fff;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-card p {
            color: #999;
            margin: 0 0.6rem;
            font-size: 0.78rem;
        }

        .movie-card .source {
            color: #666;
            font-size: 0.7rem;
            margin: 0 0.6rem 0.6rem;
            font-style: italic;
        }

        .episodes-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(10, 26, 42, 0.95);
            color: #fff;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .movie-buttons {
            display: flex;
            gap: 0.4rem;
            margin: 0.5rem 0.6rem 0.7rem;
            justify-content: center;
        }

        .movie-buttons .btn {
            flex: 1;
            padding: 0.4rem 0.5rem;
            font-size: 0.72rem;
            font-weight: 600;
            border-radius: 6px;
            min-height: 28px;
        }

        /* ==============================
           6. POPUP XEM PHIM
           ============================== */
        .watch-popup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            display: none;
        }

        .popup-content {
            background: #1a1a1a;
            padding: 1.8rem;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid #0A1A2A;
        }

        .popup-content h3 {
            margin-bottom: 1rem;
            color: #0F2A3F;
            font-size: 1.3rem;
        }

        .popup-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .popup-buttons .btn {
            flex: 1;
            min-width: 100px;
        }

        /* ==============================
           7. RESPONSIVE
           ============================== */
        @media (max-width: 992px) {
            .movie-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.4rem; }
        }

        @media (max-width: 768px) {
            header .container { flex-direction: column; gap: 0.8rem; }
            nav ul { flex-direction: column; align-items: center; gap: 0.6rem; }
            .hero h2 { font-size: 2.1rem; }
            .search-form { flex-direction: column; padding: 0 1rem; }
            .search-form input { width: 100%; }
            .movie-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1rem; }
        }

        @media (max-width: 480px) {
            .hero h2 { font-size: 1.7rem; }
            .movie-card h3 { font-size: 0.82rem; }
            .movie-buttons .btn { font-size: 0.68rem; padding: 0.35rem 0.4rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <h1 class="logo">CINEMAX</h1>
            <nav>
                <ul>
                    <li><a href="index1.html">Anime</a></li>
                    <li><a href="movies.html">Movies</a></li>
                    <li><a href="index.html">Life Shell</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="home" class="hero">
        <div class="container">
            <h2>Khám Phá Thế Giới Phim</h2>
            <p>Nhập tên Phim để tìm kiếm nhanh từ nhiều nguồn!</p>
            <div class="search-form">
                <input type="text" id="search-input" placeholder="Nhập tên Phim ví dụ:...">
                <button type="button" id="search-btn" class="btn">Tìm Kiếm</button>
            </div>
        </div>
    </section>

    <!-- Movies Section -->
    <section id="movies" class="movies" style="display:none;">
        <div class="container">
            <h2>Tìm Kiếm Phim</h2>
            <div class="movie-grid" id="movie-grid"></div>
        </div>
    </section>

    <!-- Library Section -->
    <section id="library" class="movies">
        <div class="container">
            <h2>Phim - Movies</h2>
            <div class="movie-grid" id="library-grid">
                <!-- Phim từ thư viện sẽ được thêm động -->
            </div>
        </div>
    </section>

    <!-- POPUP XEM PHIM -->
    <div id="watch-popup" class="watch-popup">
        <div class="popup-content">
            <h3>Xem phim</h3>
            <div class="popup-buttons">
                <a href="#" id="watch-now-btn" class="btn">Xem Ngay</a>
                <a href="#" id="watch-detail-btn" class="btn">Chi Tiết</a>
                <button type="button" id="close-popup" class="btn" style="background:#333;">Hủy</button>
            </div>
        </div>
    </div>

    <script>
        // Smooth scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            });
        });

        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const movieGrid = document.getElementById('movie-grid');
        const libraryGrid = document.getElementById('library-grid');
        const moviesSection = document.getElementById('movies');

        searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); searchBtn.click(); } });
        searchInput.addEventListener('input', function() { if (!this.value.trim()) { movieGrid.innerHTML = ''; moviesSection.style.display = 'none'; } });

        searchBtn.addEventListener('click', async () => {
            const slug = searchInput.value.trim().toLowerCase().replace(/\s+/g, '-');
            movieGrid.innerHTML = '';
            if (!slug) return;
            moviesSection.style.display = 'block';

            const apis = [
                { name: 'Nguonc', url: `https://phim.nguonc.com/api/film/${slug}`, dataPath: ['movie'], titleKey: 'name', descKey: 'description', posterKey: 'thumb_url', thumbKey: 'poster_url', qualityKey: 'quality', langKey: 'language' },
                { name: 'Phimapi', url: `https://phimapi.com/phim/${slug}`, dataPath: ['movie'], titleKey: 'name', descKey: 'content', posterKey: 'poster_url', thumbKey: 'thumb_url', yearKey: 'year', qualityKey: 'quality', langKey: 'lang' },
                { name: 'Ophim', url: `https://ophim1.com/v1/api/phim/${slug}`, dataPath: ['data', 'item'], titleKey: 'name', descKey: 'content', posterKey: 'thumb_url', thumbKey: 'poster_url', yearKey: 'year', qualityKey: 'quality', langKey: 'lang', cdnImage: (d) => d.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live/uploads/movies/' }
            ];

            const promises = apis.map(async api => {
                try {
                    const res = await fetch(api.url);
                    if (!res.ok) return null;
                    const data = await res.json();
                    let movie = data;
                    for (const p of api.dataPath) { if (movie && movie[p] !== undefined) movie = movie[p]; else return null; }
                    const cdn = api.cdnImage ? api.cdnImage(data) : '';
                    const poster = movie[api.posterKey] ? (cdn ? `${cdn}/${movie[api.posterKey]}` : movie[api.posterKey]) : (movie[api.thumbKey] ? (cdn ? `${cdn}/${movie[api.thumbKey]}` : movie[api.thumbKey]) : '');
                    let episodesCount = 'N/A';
                    if (api.name === 'Nguonc') episodesCount = movie.total_episodes || (movie.episodes?.[0]?.items?.length) || 'N/A';
                    if (api.name === 'Phimapi') episodesCount = movie.episode_total || (movie.episodes?.[0]?.server_data?.length) || 'N/A';
                    if (api.name === 'Ophim') episodesCount = movie.episode_total || (movie.episodes?.reduce((m, s) => Math.max(m, s.server_data?.length || 0), 0)) || 'N/A';
                    return { title: movie[api.titleKey] || 'Không rõ', description: movie[api.descKey] || '', poster, source: api.name, slug, episodesCount };
                } catch { return null; }
            });

            const movies = (await Promise.all(promises)).filter(m => m);
            if (movies.length === 0) { movieGrid.innerHTML = '<p>Không tìm thấy Phim.</p>'; return; }
            displayMovies(movies, movieGrid);
        });

        function displayMovies(movies, grid) {
            const fragment = document.createDocumentFragment();
            movies.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
                    ${movie.poster ? `<img src="${movie.poster}" alt="${movie.title}" loading="lazy" decoding="async">` : ''}
                    <span class="episodes-label">${movie.episodesCount} tập</span>
                    <h3>${movie.title}</h3>
                    <p>${movie.description.slice(0, 100)}${movie.description.length > 100 ? '...' : ''}</p>
                    <p class="source">Nguồn: ${movie.source}</p>
                    <a href="detail.html?slug=${encodeURIComponent(movie.slug)}&source=${movie.source}" class="btn view-detail">Chi Tiết</a>
                    <a href="watch.html?slug=${encodeURIComponent(movie.slug)}&source=${movie.source}&e=1" class="btn watch-movie">Xem Phim</a>
                `;
                fragment.appendChild(card);
            });
            grid.innerHTML = '';
            grid.appendChild(fragment);
        }

        // POPUP XEM PHIM
        document.querySelectorAll('.watch-movie').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const detailBtn = btn.previousElementSibling;
                document.getElementById('watch-now-btn').href = btn.href;
                document.getElementById('watch-detail-btn').href = detailBtn.href;
                document.getElementById('watch-popup').style.display = 'flex';
            });
        });

        document.getElementById('close-popup').onclick = () => document.getElementById('watch-popup').style.display = 'none';
        window.onclick = e => { if (e.target === document.getElementById('watch-popup')) document.getElementById('watch-popup').style.display = 'none'; };

        // TẢI THƯ VIỆN
        const CACHE_KEY = 'library_cache_v3';
        const CACHE_TIME = 6 * 60 * 60 * 1000;

        function getCache(key) { try { const item = localStorage.getItem(key); if (!item) return null; const { data, time } = JSON.parse(item); return Date.now() - time < CACHE_TIME ? data : null; } catch { return null; } }
        function setCache(key, data) { try { localStorage.setItem(key, JSON.stringify({ data, time: Date.now() })); } catch (e) { console.warn('Cache đầy:', e); } }

        async function loadLibrary() {
    const grid = document.getElementById('library-grid');
    grid.innerHTML = '<p style="text-align:center; padding:20px;">Đang tải thư viện...</p>';
    try {
        const res = await fetch('hoa.txt');
        if (!res.ok) throw new Error();
        const lines = (await res.text()).trim().split('\n').filter(l => l.trim());
        if (!lines.length) { grid.innerHTML = '<p>Thư viện trống.</p>'; return; }

        const movies = [];
        const fragment = document.createDocumentFragment();

        // Định nghĩa API
        const apiMap = {
            nguonc: { url: (slug) => `https://phim.nguonc.com/api/film/${slug}`, path: ['movie'], nameKey: 'name', posterKey: 'thumb_url', epsKey: (m) => m.total_episodes || m.episodes?.[0]?.items?.length },
            phimapi: { url: (slug) => `https://phimapi.com/phim/${slug}`, path: ['movie'], nameKey: 'name', posterKey: 'poster_url', epsKey: (m) => m.episode_total || m.episodes?.[0]?.server_data?.length },
            ophim: { url: (slug) => `https://ophim1.com/v1/api/phim/${slug}`, path: ['data', 'item'], nameKey: 'name', posterKey: 'thumb_url', epsKey: (m) => m.episode_total || m.episodes?.reduce((a,s)=>Math.max(a,s.server_data?.length||0),0) }
        };

        for (const line of lines) {
            let slug, src = 'phimapi'; // mặc định
            const sourceMatch = line.match(/nguồn:\s*([^|]+)/i);
            if (sourceMatch) {
                const parts = line.split('nguồn:');
                slug = parts[0].trim();
                src = parts[1].trim().toLowerCase();
            } else {
                slug = line.trim();
            }

            const sources = src.split(',').map(s => s.trim());

            for (const source of sources) {
                if (!apiMap[source]) continue;

                const api = apiMap[source];
                const cacheKey = `lib_${slug}_${source}`;
                const cached = getCache(cacheKey);
                let data = cached;

                if (!cached) {
                    try {
                        const res = await fetch(api.url(slug));
                        if (!res.ok) continue;
                        const json = await res.json();
                        let movie = json;
                        for (const p of api.path) movie = movie?.[p];
                        if (!movie) continue;

                        const poster = movie[api.posterKey] || movie.thumb_url || '';
                        const eps = api.epsKey(movie) || 'N/A';

                        data = {
                            title: movie[api.nameKey] || 'Không rõ',
                            description: (movie.content || movie.description || '').slice(0, 100) + '...',
                            poster,
                            source: source.charAt(0).toUpperCase() + source.slice(1),
                            slug,
                            episodesCount: eps
                        };
                        setCache(cacheKey, data);
                    } catch (e) {
                        console.warn(`Lỗi tải ${source} cho ${slug}:`, e);
                        continue;
                    }
                }

                if (data && !movies.some(m => m.slug === data.slug && m.source === data.source)) {
                    movies.push(data);
                    const card = document.createElement('div');
                    card.className = 'movie-card';
                    card.innerHTML = `
                        ${data.poster ? `<img src="${data.poster}" alt="${data.title}" loading="lazy" decoding="async">` : ''}
                        <span class="episodes-label">${data.episodesCount} tập</span>
                        <h3 title="${data.title}">${data.title}</h3>
                        <p>${data.description}</p>
                        <p class="source">Nguồn: ${data.source}</p>
                        <div class="movie-buttons">
                            <a href="detail.html?slug=${encodeURIComponent(data.slug)}&source=${data.source}" class="btn view-detail">Chi Tiết</a>
                            <a href="watch.html?slug=${encodeURIComponent(data.slug)}&source=${data.source}&e=1" class="btn watch-movie">Xem Phim</a>
                        </div>
                    `;
                    fragment.appendChild(card);
                }
            }
        }

        grid.innerHTML = '';
        grid.appendChild(fragment);
        if (movies.length === 0) grid.innerHTML = '<p>Không có phim trong thư viện.</p>';
    } catch (err) {
        console.error(err);
        grid.innerHTML = '<p>Lỗi tải thư viện.</p>';
    }
}

        document.addEventListener('DOMContentLoaded', loadLibrary);
    </script>
</body>
</html>