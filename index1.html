<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phim Hay - Xem Phim Online</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #0f0f0f; color: #fff; }
    header { background-color: #1a1a1a; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    nav { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; gap: 20px; }
    .logo { font-size: 24px; font-weight: bold; color: #e50914; }
    .search-bar { flex: 1; max-width: 500px; position: relative; }
    .search-bar input { width: 100%; padding: 10px 40px 10px 15px; border: none; border-radius: 8px; background: #333; color: #fff; font-size: 14px; }
    .search-bar input::placeholder { color: #aaa; }
    .search-bar button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #e50914; font-size: 18px; cursor: pointer; }
    .nav-links { display: flex; gap: 25px; }
    .nav-links a { color: #fff; text-decoration: none; font-weight: 500; }
    .nav-links a:hover { color: #e50914; }
    .dropdown { position: relative; }
    .dropdown-content { display: none; position: absolute; background-color: #1a1a1a; min-width: 300px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 1; top: 100%; left: 0; border-radius: 8px; padding: 10px 0; }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 15px; }
    .dropdown-item { padding: 8px 0; color: #ccc; font-size: 14px; cursor: pointer; }
    .dropdown-item:hover { color: #e50914; }
    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
    .section-title { font-size: 22px; margin-bottom: 15px; }
    .movie-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .movie-card { background: #1a1a1a; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    .movie-card:hover { transform: translateY(-10px); box-shadow: 0 16px 30px rgba(229, 9, 20, 0.3); }
    .movie-card img { width: 100%; height: 300px; object-fit: cover; }
    .movie-info { padding: 12px; background: linear-gradient(transparent, #1a1a1a); }
    .movie-title { font-weight: bold; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; }
    .movie-episode { font-size: 13px; color: #e50914; margin: 4px 0; }
    .movie-source { font-size: 11px; color: #888; font-weight: bold; }
    .pagination { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
    .page-btn { min-width: 36px; height: 36px; background: #1a1a1a; color: #fff; border: 1px solid #333; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .page-btn.active { background: #e50914; border-color: #e50914; }
    .page-btn:hover:not(.active) { background: #333; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    @media (max-width: 992px) { .movie-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .movie-grid { grid-template-columns: repeat(2, 1fr); } .search-bar { display: none; } .nav-links { gap: 15px; font-size: 14px; } }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <nav>
      <div class="logo">PHIMHAY</div>

      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Tìm phim, diễn viên..." />
        <button id="search-btn">Search</button>
      </div>

      <div class="nav-links">
        <a href="#" id="home-link">Trang chủ</a>

        <!-- Thể loại -->
        <div class="dropdown">
          <a href="#">Thể loại</a>
          <div class="dropdown-content">
            <div class="dropdown-grid">
              <div>
                <div class="dropdown-item">TV Shows</div><div class="dropdown-item">Hành Động</div><div class="dropdown-item">Phim 18+</div>
                <div class="dropdown-item">Gia Đình</div><div class="dropdown-item">Hoạt Hình</div><div class="dropdown-item">Kinh Dị</div>
                <div class="dropdown-item">Khoa Học</div><div class="dropdown-item">Viễn Tưởng</div><div class="dropdown-item">Cổ Trang</div>
                <div class="dropdown-item">Chiến Tranh</div><div class="dropdown-item">Võ Thuật</div>
              </div>
              <div>
                <div class="dropdown-item">Tài Liệu</div><div class="dropdown-item">Học Đường</div><div class="dropdown-item">Tình Cảm</div>
                <div class="dropdown-item">Hình Sự</div><div class="dropdown-item">Bí Ẩn</div><div class="dropdown-item">Chính Kịch</div>
                <div class="dropdown-item">Hài Hước</div><div class="dropdown-item">Phiêu Lưu</div><div class="dropdown-item">Tâm Lý</div>
                <div class="dropdown-item">Âm Nhạc</div><div class="dropdown-item">Thần Thoại</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quốc gia -->
        <div class="dropdown">
          <a href="#">Quốc gia</a>
          <div class="dropdown-content">
            <div class="dropdown-grid">
              <div>
                <div class="dropdown-item">Âu Mỹ</div><div class="dropdown-item">Hàn Quốc</div><div class="dropdown-item">Trung Quốc</div>
                <div class="dropdown-item">Thái Lan</div><div class="dropdown-item">Nhật Bản</div><div class="dropdown-item">Ấn Độ</div><div class="dropdown-item">Pháp</div>
              </div>
              <div>
                <div class="dropdown-item">Anh</div><div class="dropdown-item">Đức</div><div class="dropdown-item">Tây Ban Nha</div>
                <div class="dropdown-item">Hồng Kông</div><div class="dropdown-item">Canada</div><div class="dropdown-item">Úc</div><div class="dropdown-item">Ý</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Phim Bộ -->
        <a href="#" id="phim-bo">Phim Bộ</a>

        <!-- Phim Lẻ -->
        <a href="#" id="phim-le">Phim Lẻ</a>

        <!-- Năm -->
        <div class="dropdown" id="year-dropdown">
          <a href="#">Năm</a>
          <div class="dropdown-content" id="year-list"></div>
        </div>

        <!-- Thuyết Minh -->
        <a href="#" id="thuyet-minh">Thuyết Minh</a>

        <!-- Chiếu Rạp -->
        <a href="#" id="chieu-rap">Chiếu Rạp</a>
      </div>
    </nav>
  </header>

  <div class="container"></div>

<script>
  // ========================================
  // SLUG MAP
  // ========================================
  const GENRE_SLUG_MAP = {
    'TV Shows': 'tv-shows', 'Hành Động': 'hanh-dong', 'Phim 18+': 'phim-18', 'Gia Đình': 'gia-dinh',
    'Hoạt Hình': 'hoat-hinh', 'Kinh Dị': 'kinh-di', 'Khoa Học': 'khoa-hoc', 'Viễn Tưởng': 'vien-tuong',
    'Cổ Trang': 'co-trang', 'Chiến Tranh': 'chien-tranh', 'Võ Thuật': 'vo-thuat', 'Tài Liệu': 'tai-lieu',
    'Học Đường': 'hoc-duong', 'Tình Cảm': 'tinh-cam', 'Hình Sự': 'hinh-su', 'Bí Ẩn': 'bi-an',
    'Chính Kịch': 'chinh-kich', 'Hài Hước': 'hai-huoc', 'Phiêu Lưu': 'phieu-luu', 'Tâm Lý': 'tam-ly',
    'Âm Nhạc': 'am-nhac', 'Thần Thoại': 'than-thoai'
  };

  const COUNTRY_SLUG_MAP = {
    'Âu Mỹ': 'au-my', 'Hàn Quốc': 'han-quoc', 'Trung Quốc': 'trung-quoc', 'Thái Lan': 'thai-lan',
    'Nhật Bản': 'nhat-ban', 'Ấn Độ': 'an-do', 'Pháp': 'phap', 'Anh': 'anh', 'Đức': 'duc',
    'Tây Ban Nha': 'tay-ban-nha', 'Hồng Kông': 'hong-kong', 'Canada': 'canada', 'Úc': 'uc', 'Ý': 'y'
  };

  const TYPE_MAP = {
    'phim-bo': 'phim-bo', 'phim-le': 'phim-le',
    'thuyet-minh': 'phim-thuyet-minh', 'chieu-rap': 'phim-chieu-rap'
  };

  // ========================================
  // CẤU HÌNH NGUỒN
  // ========================================
  const API_SOURCES = {
    Ophim: { 
      name: 'Ophim',
      defaultUrl: p => `https://ophim1.com/v1/api/danh-sach/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://ophim1.com/v1/api/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://ophim1.com/v1/api/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://ophim1.com/v1/api/nam-phat-hanh/${year}?page=${p}`,
      typeUrl: (type, p) => `https://ophim1.com/v1/api/danh-sach/${type}?page=${p}`,
      parser: d => d?.data?.items || [],
      getCdn: () => 'https://img.ophim.live/uploads/movies/'
    },
    Phimapi: { 
      name: 'Phimapi',
      defaultUrl: p => `https://phimapi.com/danh-sach/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://phimapi.com/v1/api/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://phimapi.com/v1/api/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://phimapi.com/v1/api/nam/${year}?page=${p}`,
      typeUrl: (type, p) => `https://phimapi.com/v1/api/danh-sach/${type}?page=${p}`,
      parser: d => d?.data?.items || d?.items || [],
      getCdn: d => (d?.data?.APP_DOMAIN_CDN_IMAGE || 'https://phimimg.com/').replace(/\/+$/, '') + '/'
    },
    Nguonc: { 
      name: 'Nguonc',
      defaultUrl: p => `https://phim.nguonc.com/api/films/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://phim.nguonc.com/api/films/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://phim.nguonc.com/api/films/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://phim.nguonc.com/api/films/nam-phat-hanh/${year}?page=${p}`,
      typeUrl: (type, p) => `https://phim.nguonc.com/api/films/danh-sach/${type}?page=${p}`,
      parser: d => d?.items || [],
      getCdn: () => 'https://phim.nguonc.com/public/images/Post/'
    }
  };

  // ========================================
  // BIẾN TOÀN CỤC
  // ========================================
  let currentMode = 'default', currentFilter = null, currentPage = 1;

  // ========================================
  // DOM READY
  // ========================================
  document.addEventListener('DOMContentLoaded', () => {
    initYearDropdown();
    initGenreAndCountryDropdowns();
    attachNavEvents();
    loadContent('default');
  });

  // Tạo dropdown năm
  function initYearDropdown() {
    const yearList = document.getElementById('year-list');
    for (let y = 2025; y >= 2010; y--) {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = y;
      item.dataset.year = y;
      item.style.cursor = 'pointer';
      yearList.appendChild(item);
    }
  }

  // Gắn sự kiện cho Thể loại & Quốc gia
  function initGenreAndCountryDropdowns() {
    document.querySelectorAll('.dropdown').forEach(dropdown => {
      const items = dropdown.querySelectorAll('.dropdown-item');
      items.forEach(item => {
        item.style.cursor = 'pointer';
        const text = item.textContent.trim();
        const parentText = dropdown.querySelector('a').textContent.trim();

        if (parentText === 'Thể loại') {
          const slug = GENRE_SLUG_MAP[text];
          if (slug) {
            item.dataset.slug = slug;
            item.dataset.mode = 'genre';
          }
        } else if (parentText === 'Quốc gia') {
          const slug = COUNTRY_SLUG_MAP[text];
          if (slug) {
            item.dataset.slug = slug;
            item.dataset.mode = 'country';
          }
        } else if (parentText === 'Năm') {
          item.dataset.mode = 'year';
          item.dataset.year = text;
        }

        item.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const mode = item.dataset.mode;
          const filter = mode === 'year' ? item.dataset.year : item.dataset.slug;
          if (mode && filter) {
            loadContent(mode, filter, 1);
          }
        };
      });
    });
  }

  // Gắn sự kiện cho các link chính
  function attachNavEvents() {
    document.getElementById('home-link').onclick = e => { e.preventDefault(); loadContent('default'); };
    document.getElementById('phim-bo').onclick = e => { e.preventDefault(); loadContent('type', 'phim-bo', 1); };
    document.getElementById('phim-le').onclick = e => { e.preventDefault(); loadContent('type', 'phim-le', 1); };
    document.getElementById('thuyet-minh').onclick = e => { e.preventDefault(); loadContent('type', 'thuyet-minh', 1); };
    document.getElementById('chieu-rap').onclick = e => { e.preventDefault(); loadContent('type', 'chieu-rap', 1); };

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    searchBtn.onclick = search;
    searchInput.addEventListener('keypress', e => e.key === 'Enter' && search());
    searchInput.addEventListener('input', () => {
      if (!searchInput.value.trim()) loadContent('default');
    });
  }

  // ========================================
  // SECTION MANAGEMENT
  // ========================================
  function createSection(id, title) {
    const section = document.createElement('div');
    section.id = id;
    section.innerHTML = `
      <div class="section-title">${title}</div>
      <div class="movie-grid" id="${id}-grid"></div>
      <div class="pagination" id="${id}-pagination"></div>
    `;
    return section;
  }

  function hideAllSections() {
    document.querySelectorAll('.container > div[id$="-section"]').forEach(sec => {
      sec.style.display = 'none';
    });
  }

  function showSection(section) {
    hideAllSections();
    const container = document.querySelector('.container');
    const existing = document.getElementById(section.id);
    if (existing) {
      existing.style.display = 'block';
      container.insertBefore(existing, container.firstChild);
    } else {
      container.insertBefore(section, container.firstChild);
      section.style.display = 'block';
    }
  }

  // ========================================
  // FETCH + PARSER
  // ========================================
  async function fetchFromSource(source, page, mode, filter) {
    let url;
    try {
      if (mode === 'genre') url = source.genreUrl(filter, page);
      else if (mode === 'country') url = source.countryUrl(filter, page);
      else if (mode === 'year') url = source.yearUrl(filter, page);
      else if (mode === 'type') url = source.typeUrl(TYPE_MAP[filter] || filter, page);
      else url = source.defaultUrl(page);

      console.log(`[${source.name}] Fetch: ${url}`);
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      const items = source.parser(data) || [];
      const cdn = typeof source.getCdn === 'function' ? source.getCdn(data) : source.getCdn();

      return items.map(item => {
        let thumb = item.thumb_url || item.poster_url || item.thumb || '';
        if (thumb && !thumb.startsWith('http')) {
          thumb = cdn + thumb.replace(/^\/+/, '');
        }
        return {
          name: item.name || item.origin_name || 'Không rõ',
          thumb_url: thumb || 'https://via.placeholder.com/200x300?text=No+Image',
          episode_current: formatEpisode(item),
          slug: item.slug || '',
          source: source.name
        };
      }).filter(m => m.slug);
    } catch (e) {
      console.warn(`[${source.name}] Lỗi:`, e.message);
      return [];
    }
  }

  function formatEpisode(item) {
    const c = item.episode_current || item.current_episode || '';
    const t = item.episode_total || item.total_episodes || '';
    if (c && t && c !== 'Full') return `${c}/${t}`;
    if (c === 'Full' || /hoàn tất|full/i.test(c)) return 'Hoàn tất';
    return c || 'Đang phát';
  }

  // ========================================
  // LOAD CONTENT
  // ========================================
  async function loadContent(mode, filter = null, page = 1) {
    currentMode = mode; currentFilter = filter; currentPage = page;

    let title = '';
    if (mode === 'default') title = 'PHIM MỚI CẬP NHẬT';
    else if (mode === 'genre') title = `THỂ LOẠI: ${getDisplayName(filter, GENRE_SLUG_MAP).toUpperCase()}`;
    else if (mode === 'country') title = `QUỐC GIA: ${getDisplayName(filter, COUNTRY_SLUG_MAP).toUpperCase()}`;
    else if (mode === 'year') title = `NĂM: ${filter}`;
    else if (mode === 'type') {
      const map = { 'phim-bo': 'PHIM BỘ', 'phim-le': 'PHIM LẺ', 'thuyet-minh': 'THUYẾT MINH', 'chieu-rap': 'CHIẾU RẠP' };
      title = map[filter] || filter.toUpperCase();
    }

    const sectionId = mode === 'type' ? `type-${filter}-section` : `${mode}-section`;
    let section = document.getElementById(sectionId);
    if (!section) {
      section = createSection(sectionId, title);
    } else {
      section.querySelector('.section-title').textContent = title;
    }

    showSection(section);
    const grid = document.getElementById(`${sectionId}-grid`);
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa;">Đang tải...</div>';

    const sources = Object.values(API_SOURCES);
    const results = await Promise.all(sources.map(s => fetchFromSource(s, page, mode, filter)));
    const data = results.map((items, i) => ({ data: items.slice(0, 24), index: i })).filter(s => s.data.length > 0);

    const movies = interleaveAndDeduplicate(data);
    renderMovies(movies, grid);
    renderPagination(page, sectionId, movies.length >= 24);

    // Cuộn lên đầu section
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function getDisplayName(slug, map) {
    return Object.keys(map).find(k => map[k] === slug) || slug;
  }

  function interleaveAndDeduplicate(sources) {
    const interleaved = [];
    const maxLen = Math.max(...sources.map(s => s.data.length));
    for (let i = 0; i < maxLen && interleaved.length < 24; i++) {
      sources.forEach(src => {
        if (i < src.data.length && interleaved.length < 24) {
          interleaved.push({ ...src.data[i], srcIndex: src.index });
        }
      });
    }

    const seen = new Map();
    const final = [];
    for (const m of interleaved) {
      if (!seen.has(m.slug)) {
        seen.set(m.slug, true);
        final.push({
          name: m.name,
          thumb_url: m.thumb_url,
          episode_current: m.episode_current,
          slug: m.slug,
          source: ['Ophim', 'Phimapi', 'Nguonc'][m.srcIndex]
        });
        if (final.length >= 24) break;
      }
    }
    return final;
  }

  function renderMovies(movies, container) {
    container.innerHTML = '';
    if (movies.length === 0) {
      container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa;">Không tìm thấy phim</p>';
      return;
    }

    movies.forEach(m => {
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.onclick = () => location.href = `detail.html?slug=${m.slug}&source=${m.source}`;

      const img = document.createElement('img');
      img.src = m.thumb_url;
      img.loading = 'lazy';
      img.onerror = () => img.src = 'https://via.placeholder.com/200x300?text=No+Image';

      const info = document.createElement('div');
      info.className = 'movie-info';
      info.innerHTML = `
        <div class="movie-title">${m.name}</div>
        <div class="movie-episode">${m.episode_current}</div>
        <div class="movie-source">Nguồn: <strong>${m.source.toUpperCase()}</strong></div>
      `;

      card.append(img, info);
      container.appendChild(card);
    });
  }

  function renderPagination(page, sectionId, hasMore) {
    const el = document.getElementById(`${sectionId}-pagination`);
    el.innerHTML = '';

    const prev = document.createElement('button');
    prev.className = 'page-btn'; prev.textContent = '<'; prev.disabled = page === 1;
    prev.onclick = () => loadContent(currentMode, currentFilter, page - 1);
    el.appendChild(prev);

    const start = Math.max(1, page - 4);
    const end = page + 5;
    for (let i = start; i <= end; i++) {
      const btn = document.createElement('button');
      btn.className = 'page-btn';
      if (i === page) btn.classList.add('active');
      btn.textContent = i;
      btn.onclick = () => loadContent(currentMode, currentFilter, i);
      el.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = 'page-btn'; next.textContent = '>';
    next.disabled = !hasMore;
    next.onclick = () => loadContent(currentMode, currentFilter, page + 1);
    el.appendChild(next);
  }

  // ========================================
  // TÌM KIẾM - ĐÃ SỬA PHIMAPI + SCROLL TO TOP
  // ========================================
  const SEARCH_APIS = [
    { 
      url: s => `https://ophim1.com/v1/api/phim/${s}`, 
      name: 'Ophim', 
      parser: d => d?.data?.item ? [{ movie: d.data.item }] : [] 
    },
    { 
      url: s => `https://phimapi.com/phim/${s}`, 
      name: 'Phimapi', 
      parser: d => {
        if (d?.movie) return [{ movie: d.movie }];
        if (d?.items && Array.isArray(d.items)) return d.items.map(m => ({ movie: m }));
        return [];
      }
    },
    { 
      url: s => `https://phim.nguonc.com/api/film/${s}`, 
      name: 'Nguonc', 
      parser: d => d?.movie ? [{ movie: d.movie }] : [] 
    }
  ];

  async function search() {
    const raw = document.getElementById('search-input').value.trim();
    if (!raw) { 
      loadContent('default'); 
      return; 
    }

    loadContent('default');
    const section = document.getElementById('default-section');
    const grid = document.getElementById('default-section-grid');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa;">Đang tìm...</div>';

    const slug = raw.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    console.log(`Tìm kiếm: "${raw}" → slug: ${slug}`);

    const responses = await Promise.all(
      SEARCH_APIS.map(api => 
        fetch(api.url(slug), { mode: 'cors' })
          .then(r => r.ok ? r.json() : null)
          .catch(err => {
            console.warn(`[${api.name}] Lỗi fetch:`, err);
            return null;
          })
      )
    );

    const movies = [];
    responses.forEach((data, i) => {
      if (!data) return;
      const sourceName = SEARCH_APIS[i].name;
      const items = SEARCH_APIS[i].parser(data);
      console.log(`[${sourceName}] → ${items.length} kết quả`);

      items.forEach(({ movie }) => {
        if (!movie?.slug) return;

        let thumb = movie.thumb_url || movie.poster_url || '';
        if (sourceName === 'Ophim' && thumb && !thumb.startsWith('http')) {
          thumb = `https://img.ophim.live/uploads/movies/${thumb.replace(/^\/+/, '')}`;
        }
        if (sourceName === 'Nguonc' && thumb && !thumb.startsWith('http')) {
          thumb = `https://phim.nguonc.com/public/images/Post/${thumb.replace(/^\/+/, '')}`;
        }
        if (sourceName === 'Phimapi' && thumb && !thumb.startsWith('http')) {
          thumb = `https://phimimg.com/${thumb.replace(/^\/+/, '')}`;
        }

        movies.push({
          name: movie.name || movie.origin_name || 'Không rõ',
          thumb_url: thumb || 'https://via.placeholder.com/200x300?text=No+Image',
          episode_current: formatEpisode(movie),
          slug: movie.slug,
          source: sourceName
        });
      });
    });

    const seen = new Set();
    const unique = movies.filter(m => {
      const key = `${m.slug}-${m.source}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    console.log(`Tổng kết quả sau lọc: ${unique.length} phim`);

    renderMovies(unique, grid);
    document.getElementById('default-section-pagination').innerHTML = '';

    // Cuộn lên đầu kết quả tìm kiếm
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
</body>
</html>