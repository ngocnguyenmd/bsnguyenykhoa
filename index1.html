<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phim Hay - Xem Phim Online</title>
<style>
  :root {
    --primary: #e50914;
    --bg-dark: #0f0f0f;
    --card-bg: #1a1a1a;
    --text: #fff;
    --text-muted: #aaa;
    --border: #333;
    --neon-glow: 0 0 12px rgba(229, 9, 20, 0.6), 0 0 20px rgba(229, 9, 20, 0.4);
    --transition: all 0.3s ease;
    --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
    --shadow-lg: 0 16px 40px rgba(0,0,0,0.6);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { background-color: var(--bg-dark); color: var(--text); line-height: 1.5; overflow-x: hidden; }

  header {
    background-color: var(--card-bg);
    padding: 15px 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }

  nav {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    gap: 20px;
    flex-wrap: wrap;
  }

  .logo { font-size: 26px; font-weight: bold; color: var(--primary); text-shadow: 0 0 8px rgba(229, 9, 20, 0.5); }

  .search-bar { 
    flex: 1; max-width: 500px; position: relative; 
    display: flex; align-items: center;
  }
  .search-bar input {
    flex: 1; padding: 10px 40px 10px 15px; border: none; border-radius: 8px;
    background: var(--border); color: var(--text); font-size: 14px; transition: var(--transition);
  }
  .search-bar input:focus { outline: none; background: #444; box-shadow: 0 0 0 2px var(--primary); }
  .search-bar input::placeholder { color: var(--text-muted); }
  .search-bar button { 
    position: absolute; right: 5px; top: 50%; transform: translateY(-50%); 
    background: none; border: none; color: var(--primary); font-size: 18px; 
    cursor: pointer; padding: 5px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  }

  .nav-links { display: flex; gap: 25px; align-items: center; flex-wrap: wrap; }
  .nav-links a, .nav-links .dropdown-toggle { 
    color: var(--text); text-decoration: none; font-weight: 500; font-size: 15px; 
    transition: color 0.3s; position: relative; padding: 4px 0;
  }
  .nav-links a:hover, .dropdown-toggle:hover { color: var(--primary); }
  .dropdown-toggle::after {
    content: '▼'; font-size: 10px; margin-left: 4px; opacity: 0.7; transition: var(--transition);
  }
  .dropdown-toggle:hover::after { opacity: 1; transform: translateY(1px); }

  /* ẨN DROPDOWN HOÀN TOÀN */
  #genre-list, #country-list, #year-list, #cutee-list {
    visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;
    position: absolute !important; left: -9999px !important;
  }

  .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

  .section-title { 
    font-size: 22px; margin-bottom: 15px; font-weight: 600; color: var(--primary); 
    text-shadow: 0 0 8px rgba(229, 9, 20, 0.5); position: relative; padding-left: 12px;
  }
  .section-title::before {
    content: ''; position: absolute; left: 0; top: 50%; width: 4px; height: 20px;
    background: var(--primary); border-radius: 2px; transform: translateY(-50%);
  }

  .movie-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 18px; 
    padding: 16px 8px; 
  }

  /* CARD SIÊU ĐẸP */
  .movie-card {
    background: var(--card-bg); 
    border-radius: 14px; 
    overflow: hidden; 
    cursor: pointer;
    transition: var(--transition); 
    position: relative; 
    border: 2px solid transparent;
    box-shadow: var(--shadow-sm);
  }

  .movie-card::before {
    content: ''; 
    position: absolute; 
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    background: linear-gradient(45deg, var(--primary), #ff4d4d, #ff6b6b, var(--primary)); 
    border-radius: 16px;
    z-index: -1; 
    opacity: 0; 
    transition: opacity 0.4s ease;
    filter: blur(1px);
  }

  .movie-card:hover::before { opacity: 1; }
  .movie-card:hover { 
    transform: translateY(-14px) scale(1.03); 
    z-index: 10; 
    box-shadow: 0 0 35px rgba(229, 9, 20, 0.9), var(--shadow-lg); 
  }

  .movie-card img {
    width: 100%; 
    height: 280px; 
    object-fit: cover; 
    display: block; 
    border-radius: 12px 12px 0 0;
    background: #111;
    transition: filter 0.3s;
    filter: brightness(0.9);
  }
  .movie-card:hover img { filter: brightness(1); }

  .movie-info { 
    padding: 14px; 
    background: linear-gradient(transparent, var(--card-bg)); 
  }
  .movie-title { 
    font-weight: 600; 
    font-size: 14.5px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    color: var(--text); 
    margin-bottom: 4px;
  }
  .movie-episode { 
    font-size: 12.5px; 
    color: var(--primary); 
    margin: 4px 0; 
    font-weight: 600; 
    text-shadow: 0 0 6px rgba(229, 9, 20, 0.4);
  }
  .movie-source { 
    font-size: 10.5px; 
    color: #888; 
    font-weight: bold; 
    text-transform: uppercase; 
    letter-spacing: 0.6px; 
  }

  .pagination { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    margin: 35px 0; 
    flex-wrap: wrap; 
  }
  .page-btn {
    min-width: 40px; height: 40px; background: var(--card-bg); color: var(--text);
    border: 1.5px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14.5px;
    font-weight: 500; transition: var(--transition);
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn.active { 
    background: var(--primary); border-color: var(--primary); color: #fff; 
    box-shadow: 0 0 14px rgba(229, 9, 20, 0.7); font-weight: 600;
  }
  .page-btn:hover:not(.active) { 
    background: #333; border-color: var(--primary); 
    transform: translateY(-2px); box-shadow: 0 4px 12px rgba(229,9,20,0.3);
  }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* LOADING ĐẸP */
  .loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 50px;
    font-size: 17px;
    color: var(--text-muted);
    position: relative;
  }
  .loading::after {
    content: ''; width: 32px; height: 32px; border: 3px solid #333; border-top: 3px solid var(--primary);
    border-radius: 50%; display: inline-block; margin-left: 12px; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* MODAL SIÊU MƯỢT */
  .table-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.94);
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(16px);
    padding: 20px;
    box-sizing: border-box;
  }

  .modal-content {
    width: 100%;
    max-width: 1000px;
    height: 80vh;
    max-height: 720px;
    background: var(--card-bg);
    border-radius: 18px;
    box-shadow: 0 0 60px rgba(229,9,20,0.7);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 3px solid var(--primary);
    animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
  }

  @keyframes modalPop {
    from { transform: scale(0.75); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal-header {
    padding: 20px 26px;
    background: linear-gradient(135deg, var(--primary), #ff4d4d);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 23px;
    border-radius: 15px 15px 0 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    flex-shrink: 0;
  }

  .modal-close {
    font-size: 34px;
    cursor: pointer;
    width: 48px; height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: 0.3s;
    font-weight: 300;
  }
  .modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg) scale(1.1);
  }

  .modal-grid {
    flex: 1;
    padding: 26px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(145px, 1fr));
    gap: 18px;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) #333;
  }

  .modal-grid::-webkit-scrollbar { width: 9px; }
  .modal-grid::-webkit-scrollbar-track { background: #333; border-radius: 4px; }
  .modal-grid::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

  .modal-item {
    background: #2a2a2a;
    padding: 18px 14px;
    border-radius: 14px;
    text-align: center;
    font-size: 15.5px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
  }

  .modal-item:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-8px) scale(1.06);
    box-shadow: 0 14px 28px rgba(229,9,20,0.6);
    border-color: #ff6b6b;
  }

  /* RESPONSIVE */
  @media (max-width: 1400px) { .movie-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 1100px) { .movie-grid { grid-template-columns: repeat(4, 1fr); } }
  @media (max-width: 900px) { 
    .search-bar { display: none; } 
    .nav-links { gap: 18px; font-size: 14px; }
    .logo { font-size: 24px; }
  }
  @media (max-width: 768px) {
    nav { padding: 0 15px; gap: 15px; }
    .modal-content { height: 92vh; max-height: none; border-radius: 14px; }
    .modal-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 18px; }
    .modal-header { font-size: 19px; padding: 16px; }
  }
  @media (max-width: 500px) {
    .movie-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; padding: 12px; }
    .modal-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .modal-item { font-size: 14px; padding: 14px 10px; }
    .section-title { font-size: 20px; }
  }

  /* ICON TÌM KIẾM MOBILE */
  @media (max-width: 900px) {
    .mobile-search {
      display: flex !important;
      background: var(--border);
      border-radius: 8px;
      padding: 0 12px;
      align-items: center;
      cursor: pointer;
      color: var(--primary);
      font-size: 18px;
    }
    .mobile-search:hover { background: #444; }
  }
</style>
</head>
<body>

  <header>
    <nav>
      <div class="logo">PHIMHAY</div>

      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Tìm phim, diễn viên..." />
        <button id="search-btn">Search</button>
      </div>

      <div class="nav-links">
        <a href="#" id="home-link">Trang chủ</a>

        <!-- Thể loại -->
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Thể loại</a>
          <div class="dropdown-content" id="genre-list"></div>
        </div>

        <!-- Quốc gia -->
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Quốc gia</a>
          <div class="dropdown-content" id="country-list"></div>
        </div>

        <!-- Phim Bộ -->
        <a href="#" id="phim-bo">Phim Bộ</a>

        <!-- Phim Lẻ -->
        <a href="#" id="phim-le">Phim Lẻ</a>

        <!-- Năm -->
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Năm</a>
          <div class="dropdown-content" id="year-list"></div>
        </div>

        <!-- Cutee -->
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">Cutee</a>
          <div class="dropdown-content" id="cutee-list"></div>
        </div>

        <!-- Chiếu Rạp -->
        <a href="#" id="chieu-rap">Chiếu Rạp</a>
      </div>
    </nav>
  </header>

  <div class="container"></div>

  <!-- MODAL -->
  <div id="table-modal" class="table-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">DANH SÁCH</h2>
        <span class="modal-close">×</span>
      </div>
      <div id="modal-grid" class="modal-grid"></div>
    </div>
  </div>

 <script>
  // ========================================
  // SLUG MAP
  // ========================================
  const GENRE_SLUG_MAP = {
    'Hành Động': 'hanh-dong', 'Phiêu Lưu': 'phieu-luu', 'Hoạt Hình': 'hoat-hinh', 'Hài': 'hai',
    'Hài Hước': 'hai-huoc', 'Hình Sự': 'hinh-su', 'Tài Liệu': 'tai-lieu', 'Chính Kịch': 'chinh-kich',
    'Gia Đình': 'gia-dinh', 'Giả Tưởng': 'gia-tuong', 'Lịch Sử': 'lich-su', 'Kinh Dị': 'kinh-di',
    'Nhạc': 'nhac', 'Âm Nhạc': 'am-nhac', 'Bí Ẩn': 'bi-an', 'Lãng Mạn': 'lang-man',
    'Tình Cảm': 'tinh-cam', 'Khoa Học Viễn Tưởng': 'khoa-hoc-vien-tuong', 'Gây Cấn': 'gay-can',
    'Chiến Tranh': 'chien-tranh', 'Tâm Lý': 'tam-ly', 'Cổ Trang': 'co-trang', 'Miền Tây': 'mien-tay',
    'Phim 18+': 'phim-18', 'Thể Thao': 'the-thao', 'Võ Thuật': 'vo-thuat', 'Viễn Tưởng': 'vien-tuong',
    'Khoa Học': 'khoa-hoc', 'Thần Thoại': 'than-thoai', 'Học Đường': 'hoc-duong', 'Kinh Điển': 'kinh-dien'
  };

  const COUNTRY_SLUG_MAP = {
    'Âu Mỹ': 'au-my', 'Hàn Quốc': 'han-quoc', 'Trung Quốc': 'trung-quoc', 'Nhật Bản': 'nhat-ban',
    'Thái Lan': 'thai-lan', 'Hồng Kông': 'hong-kong', 'Ấn Độ': 'an-do', 'Anh': 'anh',
    'Pháp': 'phap', 'Canada': 'canada', 'Đức': 'duc', 'Tây Ban Nha': 'tay-ban-nha', 'Úc': 'uc',
    'Ý': 'y', 'Hà Lan': 'ha-lan', 'Indonesia': 'indonesia', 'Nga': 'nga', 'Mexico': 'mexico',
    'Ba Lan': 'ba-lan', 'Malaysia': 'malaysia', 'Bồ Đào Nha': 'bo-dao-nha', 'Thụy Điển': 'thuy-dien',
    'Philippines': 'philippines', 'Đan Mạch': 'dan-mach', 'Thụy Sĩ': 'thuy-si', 'Ukraina': 'ukraina',
    'UAE': 'uae', 'Ả Rập Xê Út': 'a-rap-xe-ut', 'Thổ Nhĩ Kỳ': 'tho-nhi-ky', 'Brazil': 'brazil',
    'Na Uy': 'na-uy', 'Nam Phi': 'nam-phi', 'Việt Nam': 'viet-nam', 'Đài Loan': 'dai-loan',
    'Châu Phi': 'chau-phi', 'Bỉ': 'bi', 'Ireland': 'ireland', 'Colombia': 'colombia',
    'Phần Lan': 'phan-lan', 'Chile': 'chile', 'Hy Lạp': 'hy-lap', 'Nigeria': 'nigeria',
    'Argentina': 'argentina', 'Singapore': 'singapore', 'Quốc Gia Khác': 'quoc-gia-khac'
  };

  const TYPE_MAP = {
    'phim-bo': 'phim-bo', 'phim-le': 'phim-le',
    'thuyet-minh': 'phim-thuyet-minh', 'chieu-rap': 'phim-chieu-rap'
  };

  const CUTEE_MENU = {
    'Phim mới':               { mode: 'default' },
    'Phim bộ':                { mode: 'type',   filter: 'phim-bo' },
    'Phim lẻ':                { mode: 'type',   filter: 'phim-le' },
    'Shows':                  { mode: 'cutee',  slug: 'tv-shows' },
    'Hoạt hình':              { mode: 'genre',  filter: 'hoat-hinh' },
    'Phim vietsub':           { mode: 'cutee',  slug: 'vietsub' },
    'Phim thuyết minh':       { mode: 'cutee',  slug: 'thuyet-minh' },
    'Phim lồng tiếng':        { mode: 'cutee',  slug: 'long-tieng' },
    'Phim bộ đang chiếu':     { mode: 'cutee',  slug: 'dang-chieu' },
    'Phim bộ đã hoàn thành':  { mode: 'cutee',  slug: 'hoan-tat' },
    'Phim sắp chiếu':         { mode: 'cutee',  slug: 'sap-chieu' },
    'Subteam':                { mode: 'cutee',  slug: 'subteam' },
    'Phim chiếu rạp':         { mode: 'cutee',  slug: 'chieu-rap' }
  };

  // ========================================
  // CẤU HÌNH NGUỒN
  // ========================================
  const API_SOURCES = {
    Ophim: {
      name: 'Ophim',
      defaultUrl: p => `https://ophim1.com/v1/api/danh-sach/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://ophim1.com/v1/api/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://ophim1.com/v1/api/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://ophim1.com/v1/api/nam-phat-hanh/${year}?page=${p}`,
      typeUrl: (type, p) => `https://ophim1.com/v1/api/danh-sach/${type}?page=${p}`,
      cuteeUrl: (slug, p) => `https://ophim1.com/v1/api/danh-sach/${slug}?page=${p}`,
      searchUrl: slug => `https://ophim1.com/v1/api/phim/${slug}`,
      parser: d => d?.data?.items || [],
      searchParser: d => d?.data?.item ? [d.data.item] : [],
      getCdn: () => 'https://img.ophim.live/uploads/movies/'
    },
    Phimapi: {
      name: 'Phimapi',
      defaultUrl: p => `https://phimapi.com/danh-sach/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://phimapi.com/v1/api/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://phimapi.com/v1/api/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://phimapi.com/v1/api/nam/${year}?page=${p}`,
      typeUrl: (type, p) => `https://phimapi.com/v1/api/danh-sach/${type}?page=${p}`,
      cuteeUrl: (slug, p) => `https://phimapi.com/v1/api/danh-sach/${slug}?page=${p}`,
      searchUrl: slug => `https://phimapi.com/phim/${slug}`,
      parser: d => d?.data?.items || d?.items || [],
      searchParser: d => d?.movie ? [d.movie] : [],
      getCdn: d => (d?.data?.APP_DOMAIN_CDN_IMAGE || 'https://phimimg.com/').replace(/\/+$/, '') + '/'
    },
    Nguonc: {
      name: 'Nguonc',
      defaultUrl: p => `https://phim.nguonc.com/api/films/phim-moi-cap-nhat?page=${p}`,
      genreUrl: (slug, p) => `https://phim.nguonc.com/api/films/the-loai/${slug}?page=${p}`,
      countryUrl: (slug, p) => `https://phim.nguonc.com/api/films/quoc-gia/${slug}?page=${p}`,
      yearUrl: (year, p) => `https://phim.nguonc.com/api/films/nam-phat-hanh/${year}?page=${p}`,
      typeUrl: (type, p) => `https://phim.nguonc.com/api/films/danh-sach/${type}?page=${p}`,
      cuteeUrl: (slug, p) => {
        const map = { 'tv-shows': 'tv-shows', 'dang-chieu': 'phim-dang-chieu', 'hoat-hinh': 'hoat-hinh' };
        return `https://phim.nguonc.com/api/films/danh-sach/${map[slug] || slug}?page=${p}`;
      },
      searchUrl: slug => `https://phim.nguonc.com/api/film/${slug}`,
      parser: d => d?.items || [],
      searchParser: d => d?.movie ? [d.movie] : [],
      getCdn: () => 'https://phim.nguonc.com/public/images/Post/'
    }
  };

  const ITEMS_PER_PAGE = 10;
  let currentMode = 'default', currentFilter = null, currentPage = 1;
  let currentSearchQuery = '';

  // Cache ảnh
  const imageCache = new Map();

  // ========================================
  // DOM READY
  // ========================================
  document.addEventListener('DOMContentLoaded', () => {
    renderDropdowns();
    initYearDropdown();
    attachNavEvents();
    loadContent('default');
  });

  // ========================================
  // RENDER DROPDOWNS (chỉ để lấy dữ liệu, không hiển thị)
  // ========================================
  function renderDropdowns() {
    renderGenreDropdown();
    renderCountryDropdown();
    renderCuteeDropdown();
  }

  function renderGenreDropdown() {
    const list = document.getElementById('genre-list');
    list.innerHTML = '<div class="dropdown-grid"></div>';
    const grid = list.querySelector('.dropdown-grid');
    const half = Math.ceil(Object.keys(GENRE_SLUG_MAP).length / 2);
    const keys = Object.keys(GENRE_SLUG_MAP);

    for (let i = 0; i < keys.length; i += half) {
      const col = document.createElement('div');
      for (let j = i; j < Math.min(i + half, keys.length); j++) {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = keys[j];
        item.dataset.slug = GENRE_SLUG_MAP[keys[j]];
        item.dataset.mode = 'genre';
        col.appendChild(item);
      }
      grid.appendChild(col);
    }
  }

  function renderCountryDropdown() {
    const list = document.getElementById('country-list');
    list.innerHTML = '<div class="dropdown-grid"></div>';
    const grid = list.querySelector('.dropdown-grid');
    const half = Math.ceil(Object.keys(COUNTRY_SLUG_MAP).length / 2);
    const keys = Object.keys(COUNTRY_SLUG_MAP);

    for (let i = 0; i < keys.length; i += half) {
      const col = document.createElement('div');
      for (let j = i; j < Math.min(i + half, keys.length); j++) {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = keys[j];
        item.dataset.slug = COUNTRY_SLUG_MAP[keys[j]];
        item.dataset.mode = 'country';
        col.appendChild(item);
      }
      grid.appendChild(col);
    }
  }

  function renderCuteeDropdown() {
    const list = document.getElementById('cutee-list');
    list.innerHTML = '<div class="dropdown-grid"></div>';
    const grid = list.querySelector('.dropdown-grid');
    const items = Object.keys(CUTEE_MENU);
    const half = Math.ceil(items.length / 2);

    for (let i = 0; i < items.length; i += half) {
      const col = document.createElement('div');
      for (let j = i; j < Math.min(i + half, items.length); j++) {
        const label = items[j];
        const cfg = CUTEE_MENU[label];
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = label;
        item.dataset.mode = cfg.mode;
        if (cfg.slug) item.dataset.slug = cfg.slug;
        if (cfg.filter) item.dataset.filter = cfg.filter;
        col.appendChild(item);
      }
      grid.appendChild(col);
    }
  }

  function initYearDropdown() {
    const yearList = document.getElementById('year-list');
    yearList.innerHTML = '';
    for (let y = 2025; y >= 2015; y--) {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = y;
      item.dataset.year = y;
      item.dataset.mode = 'year';
      yearList.appendChild(item);
    }
  }

  // ========================================
  // EVENT LISTENERS
  // ========================================
  function attachNavEvents() {
    document.getElementById('home-link').onclick = e => { e.preventDefault(); loadContent('default'); };
    document.getElementById('phim-bo').onclick = e => { e.preventDefault(); loadContent('type', 'phim-bo', 1); };
    document.getElementById('phim-le').onclick = e => { e.preventDefault(); loadContent('type', 'phim-le', 1); };
    document.getElementById('chieu-rap').onclick = e => { e.preventDefault(); loadContent('cutee', 'chieu-rap', 1); };

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    searchBtn.onclick = search;
    searchInput.addEventListener('keypress', ev => ev.key === 'Enter' && search());
    searchInput.addEventListener('input', () => {
      if (!searchInput.value.trim()) loadContent('default');
    });
  }

  // ========================================
  // SECTION MANAGEMENT
  // ========================================
  function createSection(id, title) {
    const sec = document.createElement('div');
    sec.id = id;
    sec.innerHTML = `
      <div class="section-title">${title}</div>
      <div class="movie-grid" id="${id}-grid"></div>
      <div class="pagination" id="${id}-pagination"></div>
    `;
    return sec;
  }

  function showSection(section) {
    document.querySelectorAll('.container > div[id$="-section"]').forEach(s => s.style.display = 'none');
    const container = document.querySelector('.container');
    const existing = document.getElementById(section.id);
    if (existing) {
      existing.style.display = 'block';
      container.insertBefore(existing, container.firstChild);
    } else {
      container.insertBefore(section, container.firstChild);
      section.style.display = 'block';
    }
  }

  // ========================================
  // PRELOAD IMAGE
  // ========================================
  function preloadImage(src) {
    if (imageCache.has(src)) return imageCache.get(src);
    const img = new Image();
    img.decoding = 'async';
    img.src = src;
    imageCache.set(src, img);
    return img;
  }

  // ========================================
  // FETCH CHUNG
  // ========================================
// === THAY ĐOẠN NÀY TRONG JS ===
async function fetchFromSource(source, page, mode, filter, isSearch = false) {
  let url;
  try {
    if (isSearch) url = source.searchUrl(filter);
    else if (mode === 'genre') url = source.genreUrl(filter, page);
    else if (mode === 'country') url = source.countryUrl(filter, page);
    else if (mode === 'year') url = source.yearUrl(filter, page);
    else if (mode === 'type') url = source.typeUrl(TYPE_MAP[filter] || filter, page);
    else if (mode === 'cutee') url = source.cuteeUrl(filter, page);
    else url = source.defaultUrl(page);

    const res = await fetch(url, { mode: 'cors' });
    if (!res.ok) return [];
    const data = await res.json();

    const parser = isSearch ? (source.searchParser || source.parser) : source.parser;
    const items = parser(data) || [];
    const cdn = typeof source.getCdn === 'function' ? source.getCdn(data) : source.getCdn();

    return items.map(item => {
      let thumb = '';

      // === DÙNG ĐÚNG ẢNH TỪNG NGUỒN ===
      if (source.name === 'Phimapi') {
        thumb = item.poster_url || item.poster || item.thumb_url || item.thumb || '';
      } else {
        thumb = item.thumb_url || item.thumb || item.poster_url || item.poster || '';
      }

      if (thumb && !thumb.startsWith('http') && !thumb.startsWith('//')) {
        thumb = cdn + thumb.replace(/^\/+/, '');
      }

      return {
        name: item.name || item.origin_name || item.title || 'Không rõ',
        thumb_url: thumb || 'https://via.placeholder.com/200x300/333/fff?text=No+Image',
        episode_current: formatEpisode(item),
        slug: item.slug || '',
        source: source.name
      };
    }).filter(m => m.slug);
  } catch (e) {
    console.warn(`[${source.name}] Lỗi:`, e.message);
    return [];
  }
}

  function formatEpisode(item) {
    const c = item.episode_current || item.current_episode || item.episode || '';
    const t = item.episode_total || item.total_episodes || '';
    if (c && t && c !== 'Full') return `${c}/${t}`;
    if (c === 'Full' || /hoàn tất|full/i.test(c)) return 'Hoàn tất';
    return c || 'Đang phát';
  }

  // ========================================
  // XEN KẼ NGUỒN
  // ========================================
  function interleaveSourcesProperly(results, isSearch = false) {
    if (isSearch) {
      const final = [];
      let idx = Array(results.length).fill(0);
      while (final.length < ITEMS_PER_PAGE) {
        let added = false;
        for (let i = 0; i < results.length; i++) {
          if (idx[i] < results[i].length) {
            final.push(results[i][idx[i]]);
            idx[i]++;
            added = true;
            if (final.length >= ITEMS_PER_PAGE) break;
          }
        }
        if (!added) break;
      }
      return final;
    } else {
      const seen = new Set();
      const final = [];
      let idx = Array(results.length).fill(0);
      while (final.length < ITEMS_PER_PAGE) {
        let added = false;
        for (let i = 0; i < results.length; i++) {
          if (idx[i] < results[i].length) {
            const m = results[i][idx[i]];
            if (!seen.has(m.slug)) {
              seen.add(m.slug);
              final.push(m);
              idx[i]++;
              added = true;
              if (final.length >= ITEMS_PER_PAGE) break;
            } else {
              idx[i]++;
            }
          }
        }
        if (!added) break;
      }
      return final;
    }
  }

  // ========================================
  // LOAD CONTENT
  // ========================================
  async function loadContent(mode, filter = null, page = 1) {
    currentMode = mode; currentFilter = filter; currentPage = page;

    const title = getTitle(mode, filter);
    const sectionId = `${mode}-${filter || ''}-section`.replace(/--/g, '-');
    let section = document.getElementById(sectionId);
    if (!section) section = createSection(sectionId, title);
    else section.querySelector('.section-title').textContent = title;

    showSection(section);
    const grid = document.getElementById(`${sectionId}-grid`);
    grid.innerHTML = '<div class="loading">Đang tải từ 3 nguồn...</div>';

    const sources = Object.values(API_SOURCES);
    const promises = sources.map(s => fetchFromSource(s, page, mode, filter, false));

    const allResults = await Promise.all(promises);
    const movies = interleaveSourcesProperly(allResults, false);

    grid.innerHTML = '';
    renderMoviesFinal(movies, grid);
    renderPagination(page, sectionId, movies.length >= ITEMS_PER_PAGE);
    section.scrollIntoView({ behavior: 'smooth' });
  }

  function getTitle(mode, filter) {
    if (mode === 'default') return 'PHIM MỚI CẬP NHẬT';
    if (mode === 'genre') return `THỂ LOẠI: ${getDisplayName(filter, GENRE_SLUG_MAP).toUpperCase()}`;
    if (mode === 'country') return `QUỐC GIA: ${getDisplayName(filter, COUNTRY_SLUG_MAP).toUpperCase()}`;
    if (mode === 'year') return `NĂM: ${filter}`;
    if (mode === 'type') return { 'phim-bo': 'PHIM BỘ', 'phim-le': 'PHIM LẺ' }[filter] || filter.toUpperCase();
    if (mode === 'cutee') {
      const label = Object.keys(CUTEE_MENU).find(k => CUTEE_MENU[k].slug === filter || CUTEE_MENU[k].filter === filter);
      return label?.toUpperCase() || filter.toUpperCase().replace(/-/g, ' ');
    }
    return '';
  }

  function getDisplayName(slug, map) {
    return Object.keys(map).find(k => map[k] === slug) || slug;
  }

  // ========================================
  // RENDER CARD
  // ========================================
  function renderMoviesFinal(movies, container) {
    container.innerHTML = '';
    movies.forEach(m => container.appendChild(createMovieCard(m)));
  }

  function createMovieCard(m) {
    const card = document.createElement('div');
    card.className = 'movie-card';
    card.dataset.slug = m.slug;
    card.dataset.source = m.source;
    card.onclick = () => location.href = `detail.html?slug=${m.slug}&source=${m.source}`;

    const img = document.createElement('img');
    img.alt = m.name;
    img.loading = 'lazy';
    img.decoding = 'async';
    img.style.cssText = 'width:100%;height:280px;object-fit:cover;border-radius:10px 10px 0 0;display:block;background:#111;';

    preloadImage(m.thumb_url);
    img.src = m.thumb_url;
    img.onerror = () => img.src = 'https://via.placeholder.com/200x300/333/fff?text=No+Image';

    const info = document.createElement('div');
    info.className = 'movie-info';
    info.innerHTML = `
      <div class="movie-title">${m.name}</div>
      <div class="movie-episode">${m.episode_current}</div>
      <div class="movie-source">Nguồn: <strong>${m.source.toUpperCase()}</strong></div>
    `;

    card.append(img, info);
    return card;
  }

  function renderPagination(page, sectionId, hasMore) {
    const el = document.getElementById(`${sectionId}-pagination`);
    if (!el) return;
    el.innerHTML = '';

    const prev = document.createElement('button');
    prev.className = 'page-btn'; prev.textContent = '<'; prev.disabled = page === 1;
    prev.onclick = () => loadContent(currentMode, currentFilter, page - 1);
    el.appendChild(prev);

    for (let i = Math.max(1, page - 4); i <= page + 5; i++) {
      const btn = document.createElement('button');
      btn.className = 'page-btn';
      if (i === page) btn.classList.add('active');
      btn.textContent = i;
      btn.onclick = () => loadContent(currentMode, currentFilter, i);
      el.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = 'page-btn'; next.textContent = '>';
    next.disabled = !hasMore;
    next.onclick = () => loadContent(currentMode, currentFilter, page + 1);
    el.appendChild(next);
  }

  // ========================================
  // TÌM KIẾM
  // ========================================
  async function search(query = null, page = 1) {
    const raw = (query || document.getElementById('search-input').value).trim();
    if (!raw) return loadContent('default');

    const slug = raw.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    currentSearchQuery = raw; currentPage = page;

    const sectionId = 'search-section';
    let section = document.getElementById(sectionId);
    if (!section) section = createSection(sectionId, `TÌM: "${raw}"`);
    else section.querySelector('.section-title').textContent = `TÌM: "${raw}"`;

    showSection(section);
    const grid = document.getElementById(`${sectionId}-grid`);
    grid.innerHTML = '<div class="loading">Đang tìm kiếm từ 3 nguồn...</div>';

    const sources = Object.values(API_SOURCES);
    const searchPromises = sources.map(s => fetchFromSource(s, null, null, slug, true));

    const results = await Promise.all(searchPromises);
    const movies = interleaveSourcesProperly(results, true);

    grid.innerHTML = '';
    renderMoviesFinal(movies, grid);
    renderPagination(page, sectionId, movies.length >= ITEMS_PER_PAGE);
    section.scrollIntoView({ behavior: 'smooth' });
  }

  // ========================================
  // MODAL: MỞ KHI CLICK TIÊU ĐỀ
  // ========================================
  const modal = document.getElementById('table-modal');
  const modalGrid = document.getElementById('modal-grid');
  const modalTitle = document.getElementById('modal-title');
  const closeBtn = document.querySelector('.modal-close');

  closeBtn.onclick = () => modal.style.display = 'none';
  modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

  document.addEventListener('click', (e) => {
    const toggle = e.target.closest('.dropdown-toggle');
    if (!toggle) return;

    const dropdown = toggle.closest('.dropdown');
    if (!dropdown) return;

    const listId = dropdown.querySelector('.dropdown-content')?.id;
    if (!['genre-list', 'country-list', 'year-list', 'cutee-list'].includes(listId)) return;

    e.preventDefault();

    modalTitle.textContent = toggle.textContent.toUpperCase();
    modalGrid.innerHTML = '';

    const items = dropdown.querySelectorAll('.dropdown-item');
    items.forEach(item => {
      const clone = item.cloneNode(true);
      clone.className = 'modal-item';
      clone.onclick = (ev) => {
        ev.stopPropagation();
        modal.style.display = 'none';
        item.dispatchEvent(new MouseEvent('click', { bubbles: true }));
      };
      modalGrid.appendChild(clone);
    });

    modal.style.display = 'flex';
  });

  // Bắt click item trong modal → load phim
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('dropdown-item')) return;

    const mode = e.target.dataset.mode;
    const slug = e.target.dataset.slug;
    const filter = e.target.dataset.filter || slug;
    const year = e.target.dataset.year;

    currentSearchQuery = '';

    if (mode === 'default') loadContent('default');
    else if (mode === 'genre') loadContent('genre', filter, 1);
    else if (mode === 'country') loadContent('country', filter, 1);
    else if (mode === 'year') loadContent('year', year, 1);
    else if (mode === 'type') loadContent('type', filter, 1);
    else if (mode === 'cutee') loadContent('cutee', slug || filter, 1);
  });
</script>
</body>
</html>